<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reddit Subreddit Gallery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --color-primary: #16a34a;
        --color-primary-light: #22c55e;
        --color-primary-lighter: #86efac;
        --color-primary-bg: #f0fdf4;
        --color-accent: #86efac;
        --color-border: #dcfce7;
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: var(--color-primary-bg);
        color: #1f2937;
      }

      /* Smooth color transitions for all elements */
      * {
        transition: color 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
      }

      /* Allow SVG transitions for theme changes */
      svg {
        transition: color 0.3s ease !important;
      }

      svg circle,
      svg path {
        transition: stroke 0.3s ease, fill 0.3s ease, color 0.3s ease !important;
      }

      /* Prevent transition on img elements */
      img {
        transition: none !important;
      }

      /* Styles applied when image fails to load */
      .image-error {
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: var(--color-primary-bg);
        border: 1px dashed var(--color-border);
        color: #6b7280;
        font-size: 0.875rem;
        text-align: center;
        height: 100%;
        aspect-ratio: 1 / 1;
      }
      /* Image loading placeholder */
      .image-loading {
        display: flex;
        justify-content: center;
        align-items: center;
        background: linear-gradient(90deg, var(--color-primary-lighter) 25%, var(--color-accent) 50%, var(--color-primary-lighter) 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        height: 100%;
        aspect-ratio: 1 / 1;
      }
      @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
      }
      /* Retry button */
      .retry-btn {
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: var(--color-primary-bg);
        border: 1px dashed var(--color-border);
        color: var(--color-primary);
        font-size: 0.875rem;
        text-align: center;
        height: 100%;
        aspect-ratio: 1 / 1;
        cursor: pointer;
      }
      .retry-btn:hover {
        background-color: var(--color-border);
      }
    </style>
  </head>
  <body class="bg-green-50 text-gray-800">
    <div class="container mx-auto p-4 md:p-8">
      <!-- Title Section -->
      <header class="text-center mb-6">
        <h1 id="page-title" class="text-4xl font-bold text-green-800">
          Reddit Subreddit Gallery
        </h1>
        <p id="page-subtitle" class="text-lg text-green-600 mt-2">Top Images</p>
      </header>

      <!-- Custom Subreddit Input -->
      <div class="flex justify-center mb-6">
        <div class="w-full max-w-md">
          <input
            id="custom-subreddit-input"
            type="text"
            placeholder="Enter subreddit name or Reddit link (e.g., houseplants or https://reddit.com/r/houseplants)"
            class="w-full px-4 py-2 border-2 border-green-300 rounded-lg focus:outline-none focus:border-green-600 text-gray-800"
          />
          <button
            id="custom-subreddit-btn"
            class="w-full mt-2 bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors"
          >
            Load Subreddit
          </button>
        </div>
      </div>

      <!-- Subreddit Selector -->
      <div
        id="subreddit-selector"
        class="flex flex-wrap justify-center items-center gap-3 md:gap-4 mb-4"
      >
        <!-- Subreddit buttons will be dynamically inserted here -->
      </div>

      <!-- Time Filter -->
      <div
        id="time-filter-selector"
        class="flex flex-wrap justify-center items-center gap-3 md:gap-4 mb-8"
      >
        <!-- Time filter buttons will be dynamically inserted here -->
      </div>

      <!-- Loading Indicator -->
      <div id="loading" class="text-center py-12">
        <div class="flex justify-center items-center">
          <svg
            class="animate-spin -ml-1 mr-3 h-8 w-8 text-green-600"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
          <p class="text-xl text-green-700">Loading images from Reddit...</p>
        </div>
      </div>

      <!-- Error Message -->
      <div
        id="error-message"
        class="hidden text-center bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative"
        role="alert"
      >
        <strong class="font-bold">Failed to Load!</strong>
        <span class="block sm:inline"
          >Unable to fetch data from Reddit. Please try again later.</span
        >
      </div>

      <!-- Image Gallery -->
      <div
        id="gallery"
        class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6"
      >
        <!-- Image cards will be dynamically inserted here -->
      </div>
    </div>

    <!-- Image Preview Modal -->
    <div
      id="image-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4 transition-opacity duration-300"
    >
      <div
        class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-full overflow-y-auto transform transition-transform duration-300 scale-95"
      >
        <div class="p-4 sm:p-6 relative">
          <button
            id="modal-close-btn"
            class="absolute top-3 right-3 text-gray-400 hover:text-gray-800 text-4xl leading-none font-bold"
          >
            &times;
          </button>
          <h3
            id="modal-title"
            class="text-xl font-semibold text-gray-800 mb-4 pr-8"
          ></h3>
          <div class="flex items-center justify-center gap-4">
            <button
              id="modal-prev-btn"
              class="text-gray-600 hover:text-gray-800 text-3xl leading-none font-bold p-2 hover:bg-gray-100 rounded transition-colors"
              title="Previous image (Left arrow)"
            >
              &#10094;
            </button>
            <div class="flex justify-center bg-gray-100 rounded flex-1">
              <img
                id="modal-image"
                src=""
                alt="Image Preview"
                class="max-h-[70vh] w-auto mx-auto rounded"
              />
            </div>
            <button
              id="modal-next-btn"
              class="text-gray-600 hover:text-gray-800 text-3xl leading-none font-bold p-2 hover:bg-gray-100 rounded transition-colors"
              title="Next image (Right arrow)"
            >
              &#10095;
            </button>
          </div>
          <div class="mt-5 text-center">
            <a
              id="modal-link"
              href="#"
              target="_blank"
              rel="noopener noreferrer"
              class="inline-block bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors shadow hover:shadow-lg"
            >
              View on Reddit
            </a>
          </div>
        </div>
      </div>
    </div>

    <script>
      const galleryContainer = document.getElementById("gallery");
      const loadingIndicator = document.getElementById("loading");
      const errorMessage = document.getElementById("error-message");
      const subredditSelector = document.getElementById("subreddit-selector");
      const timeFilterSelector = document.getElementById(
        "time-filter-selector"
      );
      const pageTitle = document.getElementById("page-title");
      const pageSubtitle = document.getElementById("page-subtitle");
      const customSubredditInput = document.getElementById("custom-subreddit-input");
      const customSubredditBtn = document.getElementById("custom-subreddit-btn");

      const modal = document.getElementById("image-modal");
      const modalImage = document.getElementById("modal-image");
      const modalTitle = document.getElementById("modal-title");
      const modalLink = document.getElementById("modal-link");
      const modalCloseBtn = document.getElementById("modal-close-btn");
      const modalPrevBtn = document.getElementById("modal-prev-btn");
      const modalNextBtn = document.getElementById("modal-next-btn");

      let currentImageIndex = 0;
      let imagePosts = [];
      let imageObserver = null;
      const imageRetryMap = new Map(); // Track retry attempts for each image

      const subreddits = [
        { name: "houseplants", displayName: "Houseplants" },
        { name: "SavageGarden", displayName: "Carnivorous Plants" },
      ];

      const timeFilters = [
        { name: "day", displayName: "Today" },
        { name: "week", displayName: "This Week" },
        { name: "month", displayName: "This Month" },
      ];

      let currentSubreddit = subreddits[0].name;
      let currentTimeFilter = timeFilters[0];

      const buildApiUrl = (subreddit, time) =>
        `https://www.reddit.com/r/${subreddit}/top/.json?t=${time}&limit=100`;

      const buildSubredditInfoUrl = (subreddit) =>
        `https://www.reddit.com/r/${subreddit}/about.json`;

      // Default theme colors
      const defaultTheme = {
        primary: "#16a34a",    // green-600
        secondary: "#86efac",  // green-300
        background: "#f0fdf4", // green-50
      };

      // Validate hex color
      function isValidHexColor(color) {
        return /^#[0-9A-F]{6}$/i.test(color);
      }

      // Convert hex to RGB
      function hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result
          ? {
              r: parseInt(result[1], 16),
              g: parseInt(result[2], 16),
              b: parseInt(result[3], 16),
            }
          : null;
      }

      // Convert RGB to hex
      function rgbToHex(r, g, b) {
        return "#" + [r, g, b].map((x) => {
          const hex = x.toString(16);
          return hex.length === 1 ? "0" + hex : hex;
        }).join("");
      }

      // Lighten color by percentage
      function lightenColor(hex, percent) {
        const rgb = hexToRgb(hex);
        if (!rgb) return hex;
        const factor = 1 + percent / 100;
        return rgbToHex(
          Math.min(255, Math.round(rgb.r * factor)),
          Math.min(255, Math.round(rgb.g * factor)),
          Math.min(255, Math.round(rgb.b * factor))
        );
      }

      // Darken color by percentage
      function darkenColor(hex, percent) {
        const rgb = hexToRgb(hex);
        if (!rgb) return hex;
        const factor = 1 - percent / 100;
        return rgbToHex(
          Math.max(0, Math.round(rgb.r * factor)),
          Math.max(0, Math.round(rgb.g * factor)),
          Math.max(0, Math.round(rgb.b * factor))
        );
      }

      // Calculate color brightness (0-1, where 1 is brightest)
      function getColorBrightness(hex) {
        const rgb = hexToRgb(hex);
        if (!rgb) return 0.5;
        // Using luminance formula from WCAG
        const luminance =
          (0.299 * rgb.r + 0.587 * rgb.g + 0.114 * rgb.b) / 255;
        return luminance;
      }

      // Determine if text should be light or dark based on background brightness
      function getTextColorForBackground(bgHex) {
        const brightness = getColorBrightness(bgHex);
        return brightness > 0.5 ? "#000000" : "#FFFFFF";
      }

      // Calculate optimal background brightness
      function getOptimalBackgroundColor(primaryHex) {
        const brightness = getColorBrightness(primaryHex);
        // If primary color is already light, use less light background
        // If primary color is dark, use more light background
        if (brightness < 0.3) {
          return lightenColor(primaryHex, 95); // Very light for dark colors
        } else if (brightness < 0.6) {
          return lightenColor(primaryHex, 90); // Light for medium colors
        } else {
          return lightenColor(primaryHex, 85); // Slightly less light for bright colors
        }
      }

      // Fetch subreddit theme colors
      async function fetchSubredditTheme(subreddit) {
        try {
          const response = await fetch(buildSubredditInfoUrl(subreddit));
          if (!response.ok) throw new Error("Failed to fetch subreddit info");

          const data = await response.json();
          const subredditData = data.data;

          // Extract primary color from subreddit theme
          let primaryColor = subredditData.primary_color;
          let accentColor = subredditData.key_color;

          // Validate colors - Reddit sometimes returns empty strings or invalid colors
          if (!isValidHexColor(primaryColor)) {
            primaryColor = defaultTheme.primary;
          }
          if (!isValidHexColor(accentColor)) {
            accentColor = primaryColor;
          }

          return {
            primary: primaryColor,
            accent: accentColor,
          };
        } catch (error) {
          console.warn(`Could not fetch theme for /r/${subreddit}:`, error);
          return {
            primary: defaultTheme.primary,
            accent: defaultTheme.primary,
          };
        }
      }

      // Apply theme colors to entire page
      function applyTheme(theme) {
        const primary = theme.primary;
        const light = lightenColor(primary, 30);
        const lighter = lightenColor(primary, 60);
        const bgLight = getOptimalBackgroundColor(primary);
        const border = lightenColor(primary, 80);

        // Determine text colors based on brightness
        const primaryTextColor = getTextColorForBackground(primary);
        const lightTextColor = getTextColorForBackground(light);

        // Set CSS variables
        document.documentElement.style.setProperty("--color-primary", primary);
        document.documentElement.style.setProperty("--color-primary-light", light);
        document.documentElement.style.setProperty("--color-primary-lighter", lighter);
        document.documentElement.style.setProperty("--color-primary-bg", bgLight);
        document.documentElement.style.setProperty("--color-accent", lighter);
        document.documentElement.style.setProperty("--color-border", border);

        // Update body background
        document.body.style.backgroundColor = bgLight;

        // Update titles and headers
        const pageTitle = document.getElementById("page-title");
        const pageSubtitle = document.getElementById("page-subtitle");

        if (pageTitle) {
          pageTitle.style.color = primary;
        }
        // Make subtitle darker and more readable
        if (pageSubtitle) {
          pageSubtitle.style.color = getColorBrightness(primary) > 0.6 ? darkenColor(primary, 20) : light;
          pageSubtitle.style.fontWeight = "600";
        }

        // Update input border and styling
        const input = document.getElementById("custom-subreddit-input");
        if (input) {
          input.style.borderColor = primary;
          input.style.borderWidth = "2px";
        }

        // Update all buttons with proper colors
        document.querySelectorAll("button").forEach((btn) => {
          // Subreddit selector buttons
          if (btn.parentId === "subreddit-selector" || btn.closest("#subreddit-selector")) {
            btn.style.backgroundColor = "white";
            btn.style.color = primary;
            btn.style.borderColor = light;
          }
          // Time filter buttons
          else if (btn.closest("#time-filter-selector")) {
            btn.style.backgroundColor = border;
            btn.style.color = primary;
          }
          // Main action buttons
          else if (
            btn.classList.contains("bg-green-600") ||
            btn.id === "custom-subreddit-btn"
          ) {
            btn.style.backgroundColor = primary;
            btn.style.color = "white";
          }
          // Modal navigation buttons
          else if (
            btn.id === "modal-prev-btn" ||
            btn.id === "modal-next-btn"
          ) {
            btn.style.color = primary;
          }
        });

        // Update links
        document.querySelectorAll("a").forEach((link) => {
          if (link.classList.contains("bg-green-600")) {
            link.style.backgroundColor = primary;
            link.style.color = "white";
          }
        });

        // Update loading indicator directly
        const loadingElement = document.getElementById("loading");
        if (loadingElement) {
          loadingElement.style.color = primary;
          // Update SVG elements
          const svg = loadingElement.querySelector("svg");
          if (svg) {
            svg.style.color = primary;
            svg.style.stroke = primary;
            svg.style.fill = primary;
            svg.querySelectorAll("circle, path").forEach((el) => {
              el.style.stroke = primary;
              el.style.fill = primary;
              el.style.color = primary;
            });
          }
          // Update text
          const p = loadingElement.querySelector("p");
          if (p) {
            p.style.color = primary;
          }
        }

        // Create comprehensive style updates
        const rgb = hexToRgb(primary);
        const style = document.createElement("style");
        style.textContent = `
          body {
            background-color: ${bgLight} !important;
          }
          #page-title {
            color: ${primary} !important;
          }
          #page-subtitle {
            color: ${getColorBrightness(primary) > 0.6 ? darkenColor(primary, 20) : light} !important;
            font-weight: 600 !important;
          }
          #custom-subreddit-input {
            border-color: ${primary} !important;
          }
          #custom-subreddit-btn {
            background-color: ${primary} !important;
            color: white !important;
          }
          #custom-subreddit-btn:hover {
            background-color: ${light} !important;
          }
          #subreddit-selector button {
            background-color: white !important;
            color: ${primary} !important;
            border: 1px solid ${light} !important;
          }
          #subreddit-selector button:hover {
            background-color: ${bgLight} !important;
          }
          #subreddit-selector button.bg-green-700 {
            background-color: ${primary} !important;
            color: white !important;
          }
          #time-filter-selector button {
            background-color: ${border} !important;
            color: ${primary} !important;
          }
          #time-filter-selector button:hover {
            background-color: ${light} !important;
            color: white !important;
          }
          #time-filter-selector button.bg-green-700 {
            background-color: ${primary} !important;
            color: white !important;
          }
          .shadow-md {
            box-shadow: 0 4px 6px -1px rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.1) !important;
          }
          #error-message {
            background-color: ${lightenColor(primary, 92)} !important;
            border-color: ${primary} !important;
            color: ${primary} !important;
          }
          #error-message strong {
            color: ${primary} !important;
          }
          .image-error {
            border-color: ${border} !important;
          }
          .retry-btn {
            border-color: ${border} !important;
            color: ${primary} !important;
          }
          .retry-btn:hover {
            background-color: ${border} !important;
          }
          #loading {
            color: ${primary} !important;
          }
          #loading p {
            color: ${primary} !important;
          }
          #loading svg {
            color: ${primary} !important;
            stroke: ${primary} !important;
          }
          #loading svg circle,
          #loading svg path {
            stroke: ${primary} !important;
            fill: ${primary} !important;
            color: ${primary} !important;
          }
        `;

        // Remove old style tag if it exists
        const oldStyle = document.getElementById("theme-style");
        if (oldStyle) oldStyle.remove();

        style.id = "theme-style";
        document.head.appendChild(style);
      }

      // Parse subreddit name from URL or direct name
      function parseSubredditName(input) {
        input = input.trim();

        // Handle various Reddit URL formats
        const urlPatterns = [
          /https?:\/\/(?:www\.)?reddit\.com\/r\/([a-zA-Z0-9_-]+)/i,  // https://reddit.com/r/houseplants
          /https?:\/\/(?:www\.)?reddit\.com\/r\/([a-zA-Z0-9_-]+)\//i, // https://reddit.com/r/houseplants/
          /^r\/([a-zA-Z0-9_-]+)/i,                                     // r/houseplants
        ];

        for (const pattern of urlPatterns) {
          const match = input.match(pattern);
          if (match) {
            return match[1];
          }
        }

        // If no URL format matched, return input as-is (assume it's a subreddit name)
        if (/^[a-zA-Z0-9_-]+$/.test(input)) {
          return input;
        }

        return null;
      }

      function updateModalContent(index) {
        if (index < 0 || index >= imagePosts.length) return;

        currentImageIndex = index;
        const postData = imagePosts[index].data;

        // Set image with error handling
        modalImage.src = "";
        modalImage.onload = function () {
          // Image loaded successfully
        };
        modalImage.onerror = function () {
          // Retry with delay
          setTimeout(() => {
            modalImage.src = postData.url;
          }, 1000);
        };
        modalImage.src = postData.url;
        modalImage.alt = postData.title;
        modalTitle.textContent = postData.title;
        modalLink.href = `https://www.reddit.com${postData.permalink}`;

        // Disable previous/next buttons at boundaries
        modalPrevBtn.disabled = index === 0;
        modalNextBtn.disabled = index === imagePosts.length - 1;
        modalPrevBtn.style.opacity = index === 0 ? "0.5" : "1";
        modalNextBtn.style.opacity = index === imagePosts.length - 1 ? "0.5" : "1";
        modalPrevBtn.style.cursor = index === 0 ? "not-allowed" : "pointer";
        modalNextBtn.style.cursor = index === imagePosts.length - 1 ? "not-allowed" : "pointer";
      }

      function openModal(imageUrl, postUrl, title, index) {
        currentImageIndex = index;
        updateModalContent(index);
        modal.classList.remove("hidden");
        setTimeout(() => {
          modal.classList.add("opacity-100");
          modal.querySelector(".transform").classList.remove("scale-95");
        }, 10);
        document.body.style.overflow = "hidden";
      }

      function showPreviousImage() {
        if (currentImageIndex > 0) {
          updateModalContent(currentImageIndex - 1);
        }
      }

      function showNextImage() {
        if (currentImageIndex < imagePosts.length - 1) {
          updateModalContent(currentImageIndex + 1);
        }
      }

      function closeModal() {
        modal.classList.remove("opacity-100");
        modal.querySelector(".transform").classList.add("scale-95");
        setTimeout(() => modal.classList.add("hidden"), 300);
        document.body.style.overflow = "";
      }

      modalCloseBtn.addEventListener("click", closeModal);
      modal.addEventListener(
        "click",
        (e) => e.target === modal && closeModal()
      );
      modalPrevBtn.addEventListener("click", showPreviousImage);
      modalNextBtn.addEventListener("click", showNextImage);
      document.addEventListener(
        "keydown",
        (e) => {
          if (modal.classList.contains("hidden")) return;
          if (e.key === "Escape") {
            closeModal();
          } else if (e.key === "ArrowLeft") {
            showPreviousImage();
          } else if (e.key === "ArrowRight") {
            showNextImage();
          }
        }
      );

      // Initialize lazy loading observer
      function initImageObserver() {
        if (imageObserver) {
          imageObserver.disconnect();
        }
        imageObserver = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                const img = entry.target;
                const src = img.dataset.src;
                if (src && img.src !== src) {
                  img.src = src;
                }
              }
            });
          },
          { rootMargin: "100px" }
        );

        // Observe all pending images
        document.querySelectorAll("img[data-src]").forEach((img) => {
          imageObserver.observe(img);
        });
      }

      // Retry loading image
      function retryImageLoad(wrapper, src, altText, postIndex) {
        const retryCount = imageRetryMap.get(src) || 0;
        if (retryCount >= 3) {
          wrapper.innerHTML = `<div class="image-error p-4">Image failed to load<br/>(${altText})</div>`;
          return;
        }

        imageRetryMap.set(src, retryCount + 1);
        wrapper.innerHTML = `<div class="image-loading"></div>`;

        const img = document.createElement("img");
        img.src = src;
        img.alt = altText;
        img.className = "w-full h-auto object-cover aspect-square";

        img.onload = function () {
          wrapper.innerHTML = "";
          wrapper.appendChild(img);
        };

        img.onerror = function () {
          const retryBtn = document.createElement("div");
          retryBtn.className = "retry-btn p-4 flex flex-col gap-2";
          retryBtn.innerHTML = `<span>⟲ Retry</span><span style="font-size: 0.7rem;">Attempt ${retryCount + 1}/3</span>`;
          retryBtn.onclick = () => retryImageLoad(wrapper, src, altText, postIndex);
          wrapper.innerHTML = "";
          wrapper.appendChild(retryBtn);
        };

        wrapper.innerHTML = "";
        wrapper.appendChild(img);
      }

      async function fetchImages(subreddit, timeFilter) {
        galleryContainer.innerHTML = "";
        imageRetryMap.clear(); // Clear retry map for new gallery
        loadingIndicator.classList.remove("hidden");
        errorMessage.classList.add("hidden");
        pageTitle.textContent = `Reddit ${
          subreddits.find((s) => s.name === subreddit)?.displayName || subreddit
        } Gallery`;
        pageSubtitle.textContent = `Top images from /r/${subreddit} (${timeFilter.displayName})`;

        // Fetch and apply subreddit theme
        const theme = await fetchSubredditTheme(subreddit);
        applyTheme(theme);

        try {
          const response = await fetch(buildApiUrl(subreddit, timeFilter.name));
          if (!response.ok)
            throw new Error(`HTTP error! status: ${response.status}`);

          const data = await response.json();
          loadingIndicator.classList.add("hidden");

          imagePosts = data.data.children.filter(
            (post) =>
              post.data.post_hint === "image" ||
              (post.data.url &&
                (post.data.url.endsWith(".jpg") ||
                  post.data.url.endsWith(".png") ||
                  post.data.url.endsWith(".gif")))
          );

          if (imagePosts.length === 0) {
            errorMessage.querySelector(
              "span"
            ).textContent = `No image posts found in /r/${subreddit} (${timeFilter.displayName}).`;
            errorMessage.classList.remove("hidden");
            return;
          }

          imagePosts.forEach((post, index) => {
            const postData = post.data;
            const card = document.createElement("div");
            card.className =
              "bg-white rounded-lg shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-300 group cursor-pointer";
            card.addEventListener("click", () =>
              openModal(
                postData.url,
                `https://www.reddit.com${postData.permalink}`,
                postData.title,
                index
              )
            );

            const imgWrapper = document.createElement("div");
            imgWrapper.className = "relative";

            // Create loading placeholder
            const loadingDiv = document.createElement("div");
            loadingDiv.className = "image-loading";
            imgWrapper.appendChild(loadingDiv);

            // Create img with lazy loading for images beyond first 12
            const img = document.createElement("img");
            img.alt = postData.title;
            img.className = "w-full h-auto object-cover aspect-square";

            img.onload = function () {
              const loading = imgWrapper.querySelector(".image-loading");
              if (loading) loading.remove();
            };

            img.onerror = function () {
              retryImageLoad(imgWrapper, postData.url, postData.title, index);
            };

            // Load first 12 images immediately, rest use lazy loading
            if (index < 12) {
              img.src = postData.url;
            } else {
              img.dataset.src = postData.url;
            }

            imgWrapper.appendChild(img);

            const overlay = document.createElement("div");
            overlay.className =
              "absolute bottom-0 left-0 right-0 p-4 bg-black bg-opacity-60 text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300";
            overlay.textContent = postData.title;

            card.appendChild(imgWrapper);
            card.appendChild(overlay);
            galleryContainer.appendChild(card);
          });

          // Initialize lazy loading after rendering
          initImageObserver();
        } catch (error) {
          console.error("Fetch error:", error);
          loadingIndicator.classList.add("hidden");
          errorMessage.classList.remove("hidden");
        }
      }

      function setActiveButton(selector, activeButton) {
        if (!activeButton) return; // Add a guard to prevent errors if the button doesn't exist.
        document.querySelectorAll(selector).forEach((btn) => {
          btn.classList.remove("bg-green-700", "text-white", "shadow-md");
          btn.classList.add("bg-white", "text-green-700");
        });
        activeButton.classList.add("bg-green-700", "text-white", "shadow-md");
        activeButton.classList.remove("bg-white", "text-green-700");
      }

      // Handle custom subreddit input
      function handleCustomSubreddit() {
        const input = customSubredditInput.value;

        if (!input) {
          alert("Please enter a subreddit name or link");
          return;
        }

        const subredditName = parseSubredditName(input);

        if (!subredditName) {
          alert("Invalid subreddit name or link format. Please enter a valid name or link.");
          customSubredditInput.focus();
          return;
        }

        currentSubreddit = subredditName;
        customSubredditInput.value = ""; // Clear input field

        // Remove active state from all buttons
        document.querySelectorAll("#subreddit-selector button").forEach((btn) => {
          btn.classList.remove("bg-green-700", "text-white", "shadow-md");
          btn.classList.add("bg-white", "text-green-700");
        });

        fetchImages(currentSubreddit, currentTimeFilter);
      }

      function initializeApp() {
        // Create Subreddit buttons
        subreddits.forEach((sub) => {
          const button = document.createElement("button");
          button.className =
            "px-4 py-2 rounded-lg font-semibold transition-colors duration-200 bg-white text-green-700 shadow-sm hover:bg-green-100";
          button.textContent = sub.displayName;
          button.addEventListener("click", (e) => {
            currentSubreddit = sub.name;
            setActiveButton("#subreddit-selector button", e.target);
            fetchImages(currentSubreddit, currentTimeFilter);
          });
          subredditSelector.appendChild(button);
        });

        // Add custom subreddit input event handling
        customSubredditBtn.addEventListener("click", handleCustomSubreddit);
        customSubredditInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            handleCustomSubreddit();
          }
        });

        // Create time filter buttons
        timeFilters.forEach((filter) => {
          const button = document.createElement("button");
          button.className =
            "px-3 py-1 rounded-md text-sm font-medium transition-colors duration-200 bg-gray-200 text-gray-600 hover:bg-gray-300";
          button.textContent = filter.displayName;
          button.addEventListener("click", (e) => {
            currentTimeFilter = filter;
            setActiveButton("#time-filter-selector button", e.target);
            fetchImages(currentSubreddit, currentTimeFilter);
          });
          timeFilterSelector.appendChild(button);
        });

        // Activate default buttons and load initial data
        // FIX: Use .firstElementChild instead of .firstChild to ensure we select an element, not a text node.
        setActiveButton(
          "#subreddit-selector button",
          subredditSelector.firstElementChild
        );
        setActiveButton(
          "#time-filter-selector button",
          timeFilterSelector.firstElementChild
        );

        // Apply initial theme
        fetchSubredditTheme(currentSubreddit).then((theme) => {
          applyTheme(theme);
        });

        fetchImages(currentSubreddit, currentTimeFilter);
      }

      document.addEventListener("DOMContentLoaded", initializeApp);
    </script>
  </body>
</html>
