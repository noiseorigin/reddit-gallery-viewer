<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reddit Subreddit Gallery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      /* Styles applied when image fails to load */
      .image-error {
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #f3f4f6;
        border: 1px dashed #d1d5db;
        color: #6b7280;
        font-size: 0.875rem;
        text-align: center;
        height: 100%;
        aspect-ratio: 1 / 1;
      }
      /* Image loading placeholder */
      .image-loading {
        display: flex;
        justify-content: center;
        align-items: center;
        background: linear-gradient(90deg, #e5e7eb 25%, #d1d5db 50%, #e5e7eb 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        height: 100%;
        aspect-ratio: 1 / 1;
      }
      @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
      }
      /* Retry button */
      .retry-btn {
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #f3f4f6;
        border: 1px dashed #d1d5db;
        color: #059669;
        font-size: 0.875rem;
        text-align: center;
        height: 100%;
        aspect-ratio: 1 / 1;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .retry-btn:hover {
        background-color: #e5e7eb;
      }
    </style>
  </head>
  <body class="bg-green-50 text-gray-800">
    <div class="container mx-auto p-4 md:p-8">
      <!-- Title Section -->
      <header class="text-center mb-6">
        <h1 id="page-title" class="text-4xl font-bold text-green-800">
          Reddit Subreddit Gallery
        </h1>
        <p id="page-subtitle" class="text-lg text-green-600 mt-2">Top Images</p>
      </header>

      <!-- Custom Subreddit Input -->
      <div class="flex justify-center mb-6">
        <div class="w-full max-w-md">
          <input
            id="custom-subreddit-input"
            type="text"
            placeholder="Enter subreddit name or Reddit link (e.g., houseplants or https://reddit.com/r/houseplants)"
            class="w-full px-4 py-2 border-2 border-green-300 rounded-lg focus:outline-none focus:border-green-600 text-gray-800"
          />
          <button
            id="custom-subreddit-btn"
            class="w-full mt-2 bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors"
          >
            Load Subreddit
          </button>
        </div>
      </div>

      <!-- Subreddit Selector -->
      <div
        id="subreddit-selector"
        class="flex flex-wrap justify-center items-center gap-3 md:gap-4 mb-4"
      >
        <!-- Subreddit buttons will be dynamically inserted here -->
      </div>

      <!-- Time Filter -->
      <div
        id="time-filter-selector"
        class="flex flex-wrap justify-center items-center gap-3 md:gap-4 mb-8"
      >
        <!-- Time filter buttons will be dynamically inserted here -->
      </div>

      <!-- Loading Indicator -->
      <div id="loading" class="text-center py-12">
        <div class="flex justify-center items-center">
          <svg
            class="animate-spin -ml-1 mr-3 h-8 w-8 text-green-600"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
          <p class="text-xl text-green-700">Loading images from Reddit...</p>
        </div>
      </div>

      <!-- Error Message -->
      <div
        id="error-message"
        class="hidden text-center bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative"
        role="alert"
      >
        <strong class="font-bold">Failed to Load!</strong>
        <span class="block sm:inline"
          >Unable to fetch data from Reddit. Please try again later.</span
        >
      </div>

      <!-- Image Gallery -->
      <div
        id="gallery"
        class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6"
      >
        <!-- Image cards will be dynamically inserted here -->
      </div>
    </div>

    <!-- Image Preview Modal -->
    <div
      id="image-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4 transition-opacity duration-300"
    >
      <div
        class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-full overflow-y-auto transform transition-transform duration-300 scale-95"
      >
        <div class="p-4 sm:p-6 relative">
          <button
            id="modal-close-btn"
            class="absolute top-3 right-3 text-gray-400 hover:text-gray-800 text-4xl leading-none font-bold"
          >
            &times;
          </button>
          <h3
            id="modal-title"
            class="text-xl font-semibold text-gray-800 mb-4 pr-8"
          ></h3>
          <div class="flex items-center justify-center gap-4">
            <button
              id="modal-prev-btn"
              class="text-gray-600 hover:text-gray-800 text-3xl leading-none font-bold p-2 hover:bg-gray-100 rounded transition-colors"
              title="Previous image (Left arrow)"
            >
              &#10094;
            </button>
            <div class="flex justify-center bg-gray-100 rounded flex-1">
              <img
                id="modal-image"
                src=""
                alt="Image Preview"
                class="max-h-[70vh] w-auto mx-auto rounded"
              />
            </div>
            <button
              id="modal-next-btn"
              class="text-gray-600 hover:text-gray-800 text-3xl leading-none font-bold p-2 hover:bg-gray-100 rounded transition-colors"
              title="Next image (Right arrow)"
            >
              &#10095;
            </button>
          </div>
          <div class="mt-5 text-center">
            <a
              id="modal-link"
              href="#"
              target="_blank"
              rel="noopener noreferrer"
              class="inline-block bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors shadow hover:shadow-lg"
            >
              View on Reddit
            </a>
          </div>
        </div>
      </div>
    </div>

    <script>
      const galleryContainer = document.getElementById("gallery");
      const loadingIndicator = document.getElementById("loading");
      const errorMessage = document.getElementById("error-message");
      const subredditSelector = document.getElementById("subreddit-selector");
      const timeFilterSelector = document.getElementById(
        "time-filter-selector"
      );
      const pageTitle = document.getElementById("page-title");
      const pageSubtitle = document.getElementById("page-subtitle");
      const customSubredditInput = document.getElementById("custom-subreddit-input");
      const customSubredditBtn = document.getElementById("custom-subreddit-btn");

      const modal = document.getElementById("image-modal");
      const modalImage = document.getElementById("modal-image");
      const modalTitle = document.getElementById("modal-title");
      const modalLink = document.getElementById("modal-link");
      const modalCloseBtn = document.getElementById("modal-close-btn");
      const modalPrevBtn = document.getElementById("modal-prev-btn");
      const modalNextBtn = document.getElementById("modal-next-btn");

      let currentImageIndex = 0;
      let imagePosts = [];
      let imageObserver = null;
      const imageRetryMap = new Map(); // Track retry attempts for each image

      const subreddits = [
        { name: "houseplants", displayName: "Houseplants" },
        { name: "SavageGarden", displayName: "Carnivorous Plants" },
      ];

      const timeFilters = [
        { name: "day", displayName: "Today" },
        { name: "week", displayName: "This Week" },
        { name: "month", displayName: "This Month" },
      ];

      let currentSubreddit = subreddits[0].name;
      let currentTimeFilter = timeFilters[0];

      const buildApiUrl = (subreddit, time) =>
        `https://www.reddit.com/r/${subreddit}/top/.json?t=${time}&limit=100`;

      // Parse subreddit name from URL or direct name
      function parseSubredditName(input) {
        input = input.trim();

        // Handle various Reddit URL formats
        const urlPatterns = [
          /https?:\/\/(?:www\.)?reddit\.com\/r\/([a-zA-Z0-9_-]+)/i,  // https://reddit.com/r/houseplants
          /https?:\/\/(?:www\.)?reddit\.com\/r\/([a-zA-Z0-9_-]+)\//i, // https://reddit.com/r/houseplants/
          /^r\/([a-zA-Z0-9_-]+)/i,                                     // r/houseplants
        ];

        for (const pattern of urlPatterns) {
          const match = input.match(pattern);
          if (match) {
            return match[1];
          }
        }

        // If no URL format matched, return input as-is (assume it's a subreddit name)
        if (/^[a-zA-Z0-9_-]+$/.test(input)) {
          return input;
        }

        return null;
      }

      function updateModalContent(index) {
        if (index < 0 || index >= imagePosts.length) return;

        currentImageIndex = index;
        const postData = imagePosts[index].data;

        // Set image with error handling
        modalImage.src = "";
        modalImage.onload = function () {
          // Image loaded successfully
        };
        modalImage.onerror = function () {
          // Retry with delay
          setTimeout(() => {
            modalImage.src = postData.url;
          }, 1000);
        };
        modalImage.src = postData.url;
        modalImage.alt = postData.title;
        modalTitle.textContent = postData.title;
        modalLink.href = `https://www.reddit.com${postData.permalink}`;

        // Disable previous/next buttons at boundaries
        modalPrevBtn.disabled = index === 0;
        modalNextBtn.disabled = index === imagePosts.length - 1;
        modalPrevBtn.style.opacity = index === 0 ? "0.5" : "1";
        modalNextBtn.style.opacity = index === imagePosts.length - 1 ? "0.5" : "1";
        modalPrevBtn.style.cursor = index === 0 ? "not-allowed" : "pointer";
        modalNextBtn.style.cursor = index === imagePosts.length - 1 ? "not-allowed" : "pointer";
      }

      function openModal(imageUrl, postUrl, title, index) {
        currentImageIndex = index;
        updateModalContent(index);
        modal.classList.remove("hidden");
        setTimeout(() => {
          modal.classList.add("opacity-100");
          modal.querySelector(".transform").classList.remove("scale-95");
        }, 10);
        document.body.style.overflow = "hidden";
      }

      function showPreviousImage() {
        if (currentImageIndex > 0) {
          updateModalContent(currentImageIndex - 1);
        }
      }

      function showNextImage() {
        if (currentImageIndex < imagePosts.length - 1) {
          updateModalContent(currentImageIndex + 1);
        }
      }

      function closeModal() {
        modal.classList.remove("opacity-100");
        modal.querySelector(".transform").classList.add("scale-95");
        setTimeout(() => modal.classList.add("hidden"), 300);
        document.body.style.overflow = "";
      }

      modalCloseBtn.addEventListener("click", closeModal);
      modal.addEventListener(
        "click",
        (e) => e.target === modal && closeModal()
      );
      modalPrevBtn.addEventListener("click", showPreviousImage);
      modalNextBtn.addEventListener("click", showNextImage);
      document.addEventListener(
        "keydown",
        (e) => {
          if (modal.classList.contains("hidden")) return;
          if (e.key === "Escape") {
            closeModal();
          } else if (e.key === "ArrowLeft") {
            showPreviousImage();
          } else if (e.key === "ArrowRight") {
            showNextImage();
          }
        }
      );

      // Initialize lazy loading observer
      function initImageObserver() {
        if (imageObserver) {
          imageObserver.disconnect();
        }
        imageObserver = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                const img = entry.target;
                const src = img.dataset.src;
                if (src && img.src !== src) {
                  img.src = src;
                }
              }
            });
          },
          { rootMargin: "100px" }
        );

        // Observe all pending images
        document.querySelectorAll("img[data-src]").forEach((img) => {
          imageObserver.observe(img);
        });
      }

      // Retry loading image
      function retryImageLoad(wrapper, src, altText, postIndex) {
        const retryCount = imageRetryMap.get(src) || 0;
        if (retryCount >= 3) {
          wrapper.innerHTML = `<div class="image-error p-4">Image failed to load<br/>(${altText})</div>`;
          return;
        }

        imageRetryMap.set(src, retryCount + 1);
        wrapper.innerHTML = `<div class="image-loading"></div>`;

        const img = document.createElement("img");
        img.src = src;
        img.alt = altText;
        img.className = "w-full h-auto object-cover aspect-square";

        img.onload = function () {
          wrapper.innerHTML = "";
          wrapper.appendChild(img);
        };

        img.onerror = function () {
          const retryBtn = document.createElement("div");
          retryBtn.className = "retry-btn p-4 flex flex-col gap-2";
          retryBtn.innerHTML = `<span>‚ü≤ Retry</span><span style="font-size: 0.7rem;">Attempt ${retryCount + 1}/3</span>`;
          retryBtn.onclick = () => retryImageLoad(wrapper, src, altText, postIndex);
          wrapper.innerHTML = "";
          wrapper.appendChild(retryBtn);
        };

        wrapper.innerHTML = "";
        wrapper.appendChild(img);
      }

      async function fetchImages(subreddit, timeFilter) {
        galleryContainer.innerHTML = "";
        imageRetryMap.clear(); // Clear retry map for new gallery
        loadingIndicator.classList.remove("hidden");
        errorMessage.classList.add("hidden");
        pageTitle.textContent = `Reddit ${
          subreddits.find((s) => s.name === subreddit)?.displayName || subreddit
        } Gallery`;
        pageSubtitle.textContent = `Top images from /r/${subreddit} (${timeFilter.displayName})`;

        try {
          const response = await fetch(buildApiUrl(subreddit, timeFilter.name));
          if (!response.ok)
            throw new Error(`HTTP error! status: ${response.status}`);

          const data = await response.json();
          loadingIndicator.classList.add("hidden");

          imagePosts = data.data.children.filter(
            (post) =>
              post.data.post_hint === "image" ||
              (post.data.url &&
                (post.data.url.endsWith(".jpg") ||
                  post.data.url.endsWith(".png") ||
                  post.data.url.endsWith(".gif")))
          );

          if (imagePosts.length === 0) {
            errorMessage.querySelector(
              "span"
            ).textContent = `No image posts found in /r/${subreddit} (${timeFilter.displayName}).`;
            errorMessage.classList.remove("hidden");
            return;
          }

          imagePosts.forEach((post, index) => {
            const postData = post.data;
            const card = document.createElement("div");
            card.className =
              "bg-white rounded-lg shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-300 group cursor-pointer";
            card.addEventListener("click", () =>
              openModal(
                postData.url,
                `https://www.reddit.com${postData.permalink}`,
                postData.title,
                index
              )
            );

            const imgWrapper = document.createElement("div");
            imgWrapper.className = "relative";

            // Create loading placeholder
            const loadingDiv = document.createElement("div");
            loadingDiv.className = "image-loading";
            imgWrapper.appendChild(loadingDiv);

            // Create img with lazy loading for images beyond first 12
            const img = document.createElement("img");
            img.alt = postData.title;
            img.className = "w-full h-auto object-cover aspect-square";

            img.onload = function () {
              const loading = imgWrapper.querySelector(".image-loading");
              if (loading) loading.remove();
            };

            img.onerror = function () {
              retryImageLoad(imgWrapper, postData.url, postData.title, index);
            };

            // Load first 12 images immediately, rest use lazy loading
            if (index < 12) {
              img.src = postData.url;
            } else {
              img.dataset.src = postData.url;
            }

            imgWrapper.appendChild(img);

            const overlay = document.createElement("div");
            overlay.className =
              "absolute bottom-0 left-0 right-0 p-4 bg-black bg-opacity-60 text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300";
            overlay.textContent = postData.title;

            card.appendChild(imgWrapper);
            card.appendChild(overlay);
            galleryContainer.appendChild(card);
          });

          // Initialize lazy loading after rendering
          initImageObserver();
        } catch (error) {
          console.error("Fetch error:", error);
          loadingIndicator.classList.add("hidden");
          errorMessage.classList.remove("hidden");
        }
      }

      function setActiveButton(selector, activeButton) {
        if (!activeButton) return; // Add a guard to prevent errors if the button doesn't exist.
        document.querySelectorAll(selector).forEach((btn) => {
          btn.classList.remove("bg-green-700", "text-white", "shadow-md");
          btn.classList.add("bg-white", "text-green-700");
        });
        activeButton.classList.add("bg-green-700", "text-white", "shadow-md");
        activeButton.classList.remove("bg-white", "text-green-700");
      }

      // Handle custom subreddit input
      function handleCustomSubreddit() {
        const input = customSubredditInput.value;

        if (!input) {
          alert("Please enter a subreddit name or link");
          return;
        }

        const subredditName = parseSubredditName(input);

        if (!subredditName) {
          alert("Invalid subreddit name or link format. Please enter a valid name or link.");
          customSubredditInput.focus();
          return;
        }

        currentSubreddit = subredditName;
        customSubredditInput.value = ""; // Clear input field

        // Remove active state from all buttons
        document.querySelectorAll("#subreddit-selector button").forEach((btn) => {
          btn.classList.remove("bg-green-700", "text-white", "shadow-md");
          btn.classList.add("bg-white", "text-green-700");
        });

        fetchImages(currentSubreddit, currentTimeFilter);
      }

      function initializeApp() {
        // Create Subreddit buttons
        subreddits.forEach((sub) => {
          const button = document.createElement("button");
          button.className =
            "px-4 py-2 rounded-lg font-semibold transition-colors duration-200 bg-white text-green-700 shadow-sm hover:bg-green-100";
          button.textContent = sub.displayName;
          button.addEventListener("click", (e) => {
            currentSubreddit = sub.name;
            setActiveButton("#subreddit-selector button", e.target);
            fetchImages(currentSubreddit, currentTimeFilter);
          });
          subredditSelector.appendChild(button);
        });

        // Add custom subreddit input event handling
        customSubredditBtn.addEventListener("click", handleCustomSubreddit);
        customSubredditInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            handleCustomSubreddit();
          }
        });

        // Create time filter buttons
        timeFilters.forEach((filter) => {
          const button = document.createElement("button");
          button.className =
            "px-3 py-1 rounded-md text-sm font-medium transition-colors duration-200 bg-gray-200 text-gray-600 hover:bg-gray-300";
          button.textContent = filter.displayName;
          button.addEventListener("click", (e) => {
            currentTimeFilter = filter;
            setActiveButton("#time-filter-selector button", e.target);
            fetchImages(currentSubreddit, currentTimeFilter);
          });
          timeFilterSelector.appendChild(button);
        });

        // Activate default buttons and load initial data
        // FIX: Use .firstElementChild instead of .firstChild to ensure we select an element, not a text node.
        setActiveButton(
          "#subreddit-selector button",
          subredditSelector.firstElementChild
        );
        setActiveButton(
          "#time-filter-selector button",
          timeFilterSelector.firstElementChild
        );
        fetchImages(currentSubreddit, currentTimeFilter);
      }

      document.addEventListener("DOMContentLoaded", initializeApp);
    </script>
  </body>
</html>
