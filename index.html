<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Reddit Gallery Viewer - Browse any subreddit as a beautiful image gallery. View top photos from photography, nature, memes, art and more. Fast, free, no app needed!"
    />
    <meta
      name="keywords"
      content="reddit gallery viewer, reddit image gallery, subreddit gallery, free reddit tool, reddit browser, reddit photo gallery, reddit top posts, image viewer"
    />
    <meta name="author" content="Reddit Gallery Viewer" />
    <meta
      name="robots"
      content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"
    />

    <!-- Open Graph for Social Sharing -->
    <meta
      property="og:title"
      content="Reddit Gallery Viewer - Browse Any Subreddit as Image Gallery"
    />
    <meta
      property="og:description"
      content="View any Reddit subreddit as a beautiful image gallery. Browse top photos from photography, nature, memes, art and more. Fast, free, no app needed!"
    />
    <meta property="og:type" content="website" />
    <meta
      property="og:url"
      content="https://reddit-gallery-viewer.vercel.app/"
    />
    <meta
      property="og:image"
      content="https://reddit-gallery-viewer.vercel.app/rgv_logo.png"
    />
    <meta property="og:site_name" content="Reddit Gallery Viewer" />
    <meta name="theme-color" content="#FF4500" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta
      name="twitter:title"
      content="Reddit Gallery Viewer - Browse Any Subreddit as Image Gallery"
    />
    <meta
      name="twitter:description"
      content="View any Reddit subreddit as a beautiful image gallery. Browse top photos from photography, nature, memes, art and more. Fast, free, no app needed!"
    />
    <meta
      name="twitter:image"
      content="https://reddit-gallery-viewer.vercel.app/rgv_logo.png"
    />

    <!-- Canonical Tag (Èò≤Ê≠¢ÈáçÂ§çÂÜÖÂÆπÈóÆÈ¢ò) -->
    <link rel="canonical" href="https://reddit-gallery-viewer.vercel.app/" />

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="./rgv_logo.png" />
    <link rel="apple-touch-icon" href="./rgv_logo.png" />

    <!-- Preconnect to external resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="dns-prefetch" href="https://www.reddit.com" />
    <link rel="dns-prefetch" href="https://cdn.tailwindcss.com" />

    <title>Reddit Gallery Viewer - Browse Any Subreddit as Image Gallery | Free</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <!-- Google AdSense (commented out - to be enabled later) -->
    <!-- <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX"
     crossorigin="anonymous"></script> -->

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SSS54C3THS"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-SSS54C3THS');
    </script>

    <!-- JSON-LD Structured Data for SEO -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Reddit Gallery Viewer",
        "description": "Free online tool to browse any Reddit subreddit as a beautiful image gallery with dynamic color themes",
        "url": "https://reddit-gallery-viewer.vercel.app/",
        "applicationCategory": "UtilityApplication",
        "image": "https://reddit-gallery-viewer.vercel.app/rgv_logo.png",
        "offers": {
          "@type": "Offer",
          "price": "0",
          "priceCurrency": "USD"
        },
        "author": {
          "@type": "Organization",
          "name": "Reddit Gallery Viewer",
          "url": "https://reddit-gallery-viewer.vercel.app/"
        },
        "operatingSystem": "Web",
        "browserRequirements": "Requires JavaScript"
      }
    </script>

    <style>
      :root {
        /* Reddit Official Colors */
        --color-primary: #ff4500; /* Reddit Orange */
        --color-primary-light: #ff6d00; /* Lighter Orange */
        --color-primary-lighter: #ffb6a3; /* Very Light Orange */
        --color-primary-bg: #ffffff; /* White Background */
        --color-accent: #818384; /* Reddit Gray Accent */
        --color-border: #cccccc; /* Light Gray Border */
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: #ffffff;
        color: #1f2937;
      }

      /* Smooth color transitions for all elements */
      * {
        transition: color 0.3s ease, background-color 0.3s ease,
          border-color 0.3s ease;
      }

      /* Allow SVG transitions for theme changes */
      svg {
        transition: color 0.3s ease !important;
      }

      svg circle,
      svg path {
        transition: stroke 0.3s ease, fill 0.3s ease, color 0.3s ease !important;
      }

      /* Prevent transition on img elements */
      img {
        transition: none !important;
      }

      /* Styles applied when image fails to load */
      .image-error {
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: var(--color-primary-bg);
        border: 1px dashed var(--color-border);
        color: #6b7280;
        font-size: 0.875rem;
        text-align: center;
        height: 100%;
        aspect-ratio: 1 / 1;
      }
      /* Image loading placeholder */
      .image-loading {
        display: flex;
        justify-content: center;
        align-items: center;
        background: linear-gradient(
          90deg,
          var(--color-primary-lighter) 25%,
          var(--color-accent) 50%,
          var(--color-primary-lighter) 75%
        );
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        height: 100%;
        aspect-ratio: 1 / 1;
      }
      @keyframes shimmer {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }
      /* Retry button */
      .retry-btn {
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: var(--color-primary-bg);
        border: 1px dashed var(--color-border);
        color: var(--color-primary);
        font-size: 0.875rem;
        text-align: center;
        height: 100%;
        aspect-ratio: 1 / 1;
        cursor: pointer;
      }
      .retry-btn:hover {
        background-color: var(--color-border);
      }
    </style>
  </head>
  <body class="bg-white text-gray-800">
    <div class="container mx-auto p-4 md:p-8">
      <!-- Title Section with SEO Optimization -->
      <header class="mb-6">
        <div class="flex items-center gap-4 mb-6">
          <img src="./rgv_logo.png" alt="Reddit Gallery Viewer Logo" class="h-12 w-12 flex-shrink-0" />
          <div>
            <h1 id="page-title" class="text-4xl font-bold" style="color: #ff4500">
              Reddit Gallery Viewer
            </h1>
            <p id="page-subtitle" class="text-lg mt-1" style="color: #ff6d00">
              Free Online Tool to Browse Subreddits as Image Galleries
            </p>
          </div>
        </div>
        <p class="text-sm text-gray-600 mt-2">
          View top images from any Reddit subreddit with beautiful galleries and
          dynamic color themes.
        </p>
      </header>

      <!-- Custom Subreddit Input -->
      <div class="flex justify-center mb-8">
        <div class="w-full max-w-md">
          <label class="block text-sm text-gray-600 mb-2" style="color: #666">
            üîç Search for any Subreddit
          </label>
          <div class="flex gap-2">
            <input
              id="custom-subreddit-input"
              type="text"
              placeholder="e.g., photography, MostBeautiful..."
              class="flex-1 px-4 py-2 border-2 rounded-lg focus:outline-none text-gray-800"
              style="border-color: #cccccc; color: #1a1a1b"
            />
            <button
              id="custom-subreddit-btn"
              class="px-6 text-white font-semibold rounded-lg transition-colors"
              style="background-color: #ff4500"
              title="Press Enter to search"
            >
              Go
            </button>
          </div>
          <p class="text-xs text-gray-500 mt-2" style="color: #999">
            üí° Tip: Search by name, URL, or r/name format
          </p>
        </div>
      </div>

      <!-- Filters Section - Compact Layout -->
      <div class="mb-6 bg-gray-50 p-4 rounded-lg">
        <!-- Popular Subreddits -->
        <div class="mb-4">
          <p class="text-xs font-semibold text-gray-500 mb-2 uppercase" style="color: #888">
            Popular Subreddits
          </p>
          <div
            id="subreddit-selector"
            class="flex flex-wrap gap-2"
          >
            <!-- Subreddit buttons will be dynamically inserted here -->
          </div>
        </div>

        <!-- Recently Viewed -->
        <div id="history-container" class="mb-4 hidden">
          <p class="text-xs font-semibold text-gray-500 mb-2 uppercase" style="color: #888">
            Recently Viewed
          </p>
          <div
            id="history-selector"
            class="flex flex-wrap gap-2"
          >
            <!-- Search history buttons will be dynamically inserted here -->
          </div>
        </div>

        <!-- Time Filter -->
        <div id="time-filter-section">
          <p class="text-xs font-semibold text-gray-500 mb-2 uppercase" style="color: #888">
            üìÖ Time Period
          </p>
          <div
            id="time-filter-selector"
            class="flex flex-wrap gap-2"
          >
            <!-- Time filter buttons will be dynamically inserted here -->
          </div>
        </div>
      </div>

      <!-- Loading Indicator -->
      <div id="loading" class="text-center py-12">
        <div class="flex justify-center items-center">
          <svg
            class="animate-spin -ml-1 mr-3 h-8 w-8"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            style="color: #ff4500"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
          <p class="text-xl" style="color: #ff4500">
            Loading images from Reddit...
          </p>
        </div>
      </div>

      <!-- Error Message -->
      <div
        id="error-message"
        class="hidden text-center bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative"
        role="alert"
      >
        <strong class="font-bold">Failed to Load!</strong>
        <span class="block sm:inline"
          >Unable to fetch data from Reddit. Please try again later.</span
        >
      </div>

      <!-- Share Button -->
      <div class="flex justify-center mb-6">
        <button
          id="share-btn"
          class="px-4 py-2 rounded-lg font-semibold transition-colors duration-200 flex items-center gap-2"
          style="background-color: #ff4500; color: white;"
          title="Copy shareable link to clipboard"
        >
          <span>üîó Share Gallery</span>
        </button>
        <span
          id="share-feedback"
          class="ml-3 text-green-600 text-sm font-semibold hidden"
        >
          ‚úì Copied to clipboard!
        </span>
      </div>

      <!-- Image Gallery -->
      <div
        id="gallery"
        class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6"
      >
        <!-- Image cards will be dynamically inserted here -->
      </div>

      <!-- FAQ Section for SEO -->
      <section id="faq" class="mt-16 max-w-3xl mx-auto">
        <h2 class="text-3xl font-bold mb-8 text-center" style="color: #ff4500">
          Frequently Asked Questions
        </h2>
        <div class="space-y-4">
          <details
            class="border-2 rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition-colors"
            style="border-color: #ff6d00"
          >
            <summary class="font-semibold text-lg" style="color: #ff4500">
              How do I use Reddit Gallery Viewer?
            </summary>
            <p class="mt-3 text-gray-700 leading-relaxed">
              Simply enter any subreddit name in the search box (e.g., "photography",
              "nature", "art") or click on one of the popular subreddit buttons. The
              app will fetch and display the top images from that subreddit as a
              beautiful gallery. You can also filter by time period: today, this week,
              or this month.
            </p>
          </details>

          <details
            class="border-2 rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition-colors"
            style="border-color: #ff6d00"
          >
            <summary class="font-semibold text-lg" style="color: #ff4500">
              What subreddits can I browse?
            </summary>
            <p class="mt-3 text-gray-700 leading-relaxed">
              You can browse any public subreddit on Reddit! We provide quick buttons
              for popular image-focused subreddits like photography, nature, art,
              interior design, food, and more. However, you're not limited to these‚Äî
              simply type any subreddit name to explore it as a gallery.
            </p>
          </details>

          <details
            class="border-2 rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition-colors"
            style="border-color: #ff6d00"
          >
            <summary class="font-semibold text-lg" style="color: #ff4500">
              Do I need a Reddit account or app?
            </summary>
            <p class="mt-3 text-gray-700 leading-relaxed">
              No! Reddit Gallery Viewer is completely free and requires no account,
              login, or app installation. It's a lightweight web application that runs
              directly in your browser. Simply visit the site and start browsing.
            </p>
          </details>

          <details
            class="border-2 rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition-colors"
            style="border-color: #ff6d00"
          >
            <summary class="font-semibold text-lg" style="color: #ff4500">
              Can I view image details or comments?
            </summary>
            <p class="mt-3 text-gray-700 leading-relaxed">
              Yes! Click on any image to open it in a modal view where you can see
              the full-size image and the post title. You can also click the "View on
              Reddit" button to open the original post on Reddit where you can read
              comments and interact with the community.
            </p>
          </details>

          <details
            class="border-2 rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition-colors"
            style="border-color: #ff6d00"
          >
            <summary class="font-semibold text-lg" style="color: #ff4500">
              How do I navigate between images?
            </summary>
            <p class="mt-3 text-gray-700 leading-relaxed">
              In the image preview modal, use the Previous/Next buttons to navigate
              between images, or use keyboard shortcuts: Left Arrow to go to the
              previous image, Right Arrow to go to the next image, and Escape to
              close the modal.
            </p>
          </details>

          <details
            class="border-2 rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition-colors"
            style="border-color: #ff6d00"
          >
            <summary class="font-semibold text-lg" style="color: #ff4500">
              How are the images displayed?
            </summary>
            <p class="mt-3 text-gray-700 leading-relaxed">
              Images are displayed in a responsive grid layout (1-4 columns depending
              on screen size) showing the top posts from your selected subreddit.
              Images are lazily loaded as you scroll for optimal performance. Hover
              over an image to see the post title.
            </p>
          </details>

          <details
            class="border-2 rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition-colors"
            style="border-color: #ff6d00"
          >
            <summary class="font-semibold text-lg" style="color: #ff4500">
              Is my search history saved?
            </summary>
            <p class="mt-3 text-gray-700 leading-relaxed">
              Yes! Reddit Gallery Viewer saves your recently viewed subreddits in
              your browser's local storage. These appear in the "Recently Viewed"
              section for quick access. Your data is stored locally and never sent to
              our servers.
            </p>
          </details>

          <details
            class="border-2 rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition-colors"
            style="border-color: #ff6d00"
          >
            <summary class="font-semibold text-lg" style="color: #ff4500">
              Is Reddit Gallery Viewer free?
            </summary>
            <p class="mt-3 text-gray-700 leading-relaxed">
              Yes, completely free! There are no hidden fees, subscriptions, or
              premium features. We simply provide a beautiful, fast way to browse
              Reddit subreddits as image galleries.
            </p>
          </details>

          <details
            class="border-2 rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition-colors"
            style="border-color: #ff6d00"
          >
            <summary class="font-semibold text-lg" style="color: #ff4500">
              What if an image fails to load?
            </summary>
            <p class="mt-3 text-gray-700 leading-relaxed">
              If an image fails to load, a retry button will appear. Click it to try
              loading the image again. Some images may fail due to external hosting
              restrictions, but our automatic retry system (up to 3 attempts) handles
              most cases.
            </p>
          </details>
        </div>
      </section>

      <!-- AdSense Advertisement (commented out - to be enabled later) -->
      <!-- <div class="mt-12 text-center">
        <div style="background-color: #f9fafb; padding: 20px; border-radius: 8px; margin: 20px 0;">
          <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
          <ins class="adsbygoogle"
               style="display:block; text-align:center;"
               data-ad-layout="in-article"
               data-ad-format="fluid"
               data-ad-client="ca-pub-XXXXXXXXXXXXXXXX"
               data-ad-slot="XXXXXXXXXX"></ins>
          <script>
               (adsbygoogle = window.adsbygoogle || []).push({});
          </script>
        </div>
      </div> -->
    </div>

    <!-- Image Preview Modal -->
    <div
      id="image-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4 transition-opacity duration-300"
    >
      <div
        class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-full overflow-y-auto transform transition-transform duration-300 scale-95"
      >
        <div class="p-4 sm:p-6 relative">
          <button
            id="modal-close-btn"
            class="absolute top-3 right-3 text-gray-400 hover:text-gray-800 text-4xl leading-none font-bold"
          >
            &times;
          </button>
          <h3
            id="modal-title"
            class="text-xl font-semibold text-gray-800 mb-4 pr-8"
          ></h3>
          <div class="flex items-center justify-center gap-4">
            <button
              id="modal-prev-btn"
              class="text-gray-600 hover:text-gray-800 text-3xl leading-none font-bold p-2 hover:bg-gray-100 rounded transition-colors"
              title="Previous image (Left arrow)"
            >
              &#10094;
            </button>
            <div class="flex justify-center bg-gray-100 rounded flex-1">
              <img
                id="modal-image"
                src=""
                alt="Image Preview"
                class="max-h-[70vh] w-auto mx-auto rounded"
              />
            </div>
            <button
              id="modal-next-btn"
              class="text-gray-600 hover:text-gray-800 text-3xl leading-none font-bold p-2 hover:bg-gray-100 rounded transition-colors"
              title="Next image (Right arrow)"
            >
              &#10095;
            </button>
          </div>
          <div class="mt-5 text-center">
            <a
              id="modal-link"
              href="#"
              target="_blank"
              rel="noopener noreferrer"
              class="inline-block text-white font-bold py-2 px-6 rounded-lg transition-colors shadow hover:shadow-lg"
              style="background-color: #ff4500"
            >
              View on Reddit
            </a>
          </div>
        </div>
      </div>
    </div>

    <script>
      const galleryContainer = document.getElementById("gallery");
      const loadingIndicator = document.getElementById("loading");
      const errorMessage = document.getElementById("error-message");
      const subredditSelector = document.getElementById("subreddit-selector");
      const sortSelector = document.getElementById("sort-selector");
      const timeFilterSection = document.getElementById("time-filter-section");
      const timeFilterSelector = document.getElementById(
        "time-filter-selector"
      );
      const pageTitle = document.getElementById("page-title");
      const pageSubtitle = document.getElementById("page-subtitle");
      const customSubredditInput = document.getElementById(
        "custom-subreddit-input"
      );
      const customSubredditBtn = document.getElementById(
        "custom-subreddit-btn"
      );

      const modal = document.getElementById("image-modal");
      const modalImage = document.getElementById("modal-image");
      const modalTitle = document.getElementById("modal-title");
      const modalLink = document.getElementById("modal-link");
      const modalCloseBtn = document.getElementById("modal-close-btn");
      const modalPrevBtn = document.getElementById("modal-prev-btn");
      const modalNextBtn = document.getElementById("modal-next-btn");

      const shareBtn = document.getElementById("share-btn");
      const shareFeedback = document.getElementById("share-feedback");

      let currentImageIndex = 0;
      let imagePosts = [];
      let imageObserver = null;
      const imageRetryMap = new Map(); // Track retry attempts for each image

      const DEFAULT_SUBREDDITS = [
        { name: "photography", displayName: "üì∏ Photography" },
        { name: "EarthPorn", displayName: "üåç Nature" },
        { name: "CatsStandingUp", displayName: "üê± Cats" },
        { name: "InteriorDesign", displayName: "üè† Interior Design" },
        { name: "Art", displayName: "üé® Art" },
        { name: "FoodPorn", displayName: "üçï Food" },
        { name: "houseplants", displayName: "üå± Houseplants" },
      ];

      let subreddits = [...DEFAULT_SUBREDDITS];

      const POPULAR_SUBREDDITS_KEY = "reddit_gallery_popular_subreddits";
      const POPULAR_SUBREDDITS_TTL = 1000 * 60 * 60 * 24; // 24 hours
      const POPULAR_SUBREDDITS_LIMIT = 8;
      const MAX_VISIBLE_POSTS = 40;
      const FETCH_LIMIT = 60;
      const EAGER_IMAGE_COUNT = 6;

      const timeFilters = [
        { name: "day", displayName: "üìÜ Today" },
        { name: "week", displayName: "üìÖ This Week" },
        { name: "month", displayName: "üìä This Month" },
      ];

      let currentSubreddit = subreddits[0]?.name || "photography";
      let currentTimeFilter = timeFilters[0];

      // API ÁºìÂ≠òÊú∫Âà∂
      const apiCache = new Map();
      const CACHE_DURATION = 1000 * 60 * 5; // 5 ÂàÜÈíüÁºìÂ≠ò

      // ÊêúÁ¥¢ÂéÜÂè≤ÁºìÂ≠ò
      const SEARCH_HISTORY_KEY = "reddit_gallery_history";
      const MAX_HISTORY = 10;

      function getSearchHistory() {
        try {
          const history = localStorage.getItem(SEARCH_HISTORY_KEY);
          return history ? JSON.parse(history) : [];
        } catch (e) {
          return [];
        }
      }

      function addToSearchHistory(subreddit) {
        try {
          let history = getSearchHistory();
          // ÁßªÈô§ÈáçÂ§çÈ°π
          history = history.filter((item) => item.name !== subreddit.name);
          // Ê∑ªÂä†Âà∞ÂºÄÂ§¥
          history.unshift(subreddit);
          // ÈôêÂà∂ÂéÜÂè≤ËÆ∞ÂΩïÊï∞Èáè
          history = history.slice(0, MAX_HISTORY);
          // ‰øùÂ≠òÂà∞ localStorage
          localStorage.setItem(SEARCH_HISTORY_KEY, JSON.stringify(history));
        } catch (e) {
          console.warn("Êó†Ê≥ï‰øùÂ≠òÊêúÁ¥¢ÂéÜÂè≤:", e);
        }
      }

      const buildApiUrl = (subreddit, time) =>
        `https://www.reddit.com/r/${subreddit}/top/.json?t=${time}&limit=${FETCH_LIMIT}`;

      const buildSubredditInfoUrl = (subreddit) =>
        `https://www.reddit.com/r/${subreddit}/about.json`;

      // Ê∑ªÂä† User-Agent ÂíåÁºìÂ≠òÊîØÊåÅÁöÑ fetch
      async function fetchWithCache(url) {
        const cacheKey = url;
        const now = Date.now();

        // Ê£ÄÊü•ÁºìÂ≠ò
        if (apiCache.has(cacheKey)) {
          const cached = apiCache.get(cacheKey);
          if (now - cached.time < CACHE_DURATION) {
            console.log("Using cached data for:", url);
            return cached.data;
          }
        }

        try {
          // Detect mobile user agent
          const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
          const userAgent = isMobile
            ? "Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1"
            : "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";

          const response = await fetch(url, {
            headers: {
              "User-Agent": userAgent,
            },
          });

          if (!response.ok) throw new Error(`HTTP ${response.status}`);

          const data = await response.json();
          apiCache.set(cacheKey, { data, time: now });
          return data;
        } catch (error) {
          console.error("Fetch error:", error);
          throw error;
        }
      }

      // Default theme colors (Reddit Official Colors)
      const defaultTheme = {
        primary: "#FF4500", // Reddit Orange
        secondary: "#FFB6A3", // Light Orange
        background: "#FFF7F0", // Very Light Orange
      };

      // Validate hex color
      function isValidHexColor(color) {
        return /^#[0-9A-F]{6}$/i.test(color);
      }

      // Convert hex to RGB
      function hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result
          ? {
              r: parseInt(result[1], 16),
              g: parseInt(result[2], 16),
              b: parseInt(result[3], 16),
            }
          : null;
      }

      // Convert RGB to hex
      function rgbToHex(r, g, b) {
        return (
          "#" +
          [r, g, b]
            .map((x) => {
              const hex = x.toString(16);
              return hex.length === 1 ? "0" + hex : hex;
            })
            .join("")
        );
      }

      // Lighten color by percentage
      function lightenColor(hex, percent) {
        const rgb = hexToRgb(hex);
        if (!rgb) return hex;
        const factor = 1 + percent / 100;
        return rgbToHex(
          Math.min(255, Math.round(rgb.r * factor)),
          Math.min(255, Math.round(rgb.g * factor)),
          Math.min(255, Math.round(rgb.b * factor))
        );
      }

      // Darken color by percentage
      function darkenColor(hex, percent) {
        const rgb = hexToRgb(hex);
        if (!rgb) return hex;
        const factor = 1 - percent / 100;
        return rgbToHex(
          Math.max(0, Math.round(rgb.r * factor)),
          Math.max(0, Math.round(rgb.g * factor)),
          Math.max(0, Math.round(rgb.b * factor))
        );
      }

      // Calculate color brightness (0-1, where 1 is brightest)
      function getColorBrightness(hex) {
        const rgb = hexToRgb(hex);
        if (!rgb) return 0.5;
        // Using luminance formula from WCAG
        const luminance = (0.299 * rgb.r + 0.587 * rgb.g + 0.114 * rgb.b) / 255;
        return luminance;
      }

      // Determine if text should be light or dark based on background brightness
      function getTextColorForBackground(bgHex) {
        const brightness = getColorBrightness(bgHex);
        return brightness > 0.5 ? "#000000" : "#FFFFFF";
      }

      // Calculate optimal background brightness
      function getOptimalBackgroundColor(primaryHex) {
        const brightness = getColorBrightness(primaryHex);
        // If primary color is already light, use less light background
        // If primary color is dark, use more light background
        if (brightness < 0.3) {
          return lightenColor(primaryHex, 95); // Very light for dark colors
        } else if (brightness < 0.6) {
          return lightenColor(primaryHex, 90); // Light for medium colors
        } else {
          return lightenColor(primaryHex, 85); // Slightly less light for bright colors
        }
      }

      // Use default Reddit colors (not fetching from subreddit)
      async function fetchSubredditTheme(subreddit) {
        // Always use default Reddit colors, don't customize per subreddit
        return {
          primary: defaultTheme.primary, // #FF4500 (Reddit Orange)
          accent: defaultTheme.secondary, // #FFB6A3 (Light Orange)
        };
      }

      function sanitizeRedditImageUrl(url) {
        return url ? url.replace(/&amp;/g, "&") : "";
      }

      function selectPlaceholderResolution(resolutions) {
        if (!resolutions || resolutions.length === 0) return null;
        const targetWidth = 320;
        let candidate = resolutions[0];
        for (const res of resolutions) {
          if (res.width >= targetWidth) {
            candidate = res;
            break;
          }
        }
        return candidate || resolutions[resolutions.length - 1];
      }

      function getPostImageSources(postData) {
        const fallback = sanitizeRedditImageUrl(postData.url);
        const previewImage = postData.preview?.images?.[0];
        if (!previewImage) {
          return {
            placeholder: fallback,
            full: fallback,
          };
        }

        const resolutions = previewImage.resolutions || [];
        const placeholderRes = selectPlaceholderResolution(resolutions);
        const placeholder = sanitizeRedditImageUrl(
          placeholderRes?.url || previewImage.source?.url || fallback
        );
        const full = sanitizeRedditImageUrl(
          previewImage.source?.url || fallback
        );

        // Ensure we always have at least a fallback URL for both
        const finalPlaceholder = placeholder || full || fallback;
        const finalFull = full || fallback;

        return {
          placeholder: finalPlaceholder,
          full: finalFull,
        };
      }

      const scheduleIdle =
        window.requestIdleCallback ||
        function (cb) {
          return setTimeout(cb, 200);
        };

      function loadProgressiveImage(img, { eager = false } = {}) {
        if (!img) return;
        if (img.dataset.loadingState === "loaded") return;

        const placeholder = img.dataset.placeholder || img.dataset.fullsrc;
        const fullSrc = img.dataset.fullsrc || placeholder;

        if (!placeholder) return;

        if (!img.dataset.placeholderApplied) {
          img.src = placeholder;
          img.dataset.placeholderApplied = "true";
          img.dataset.loadingState = "placeholder";
        }

        const upgradeToHighRes = () => {
          if (
            !fullSrc ||
            fullSrc === img.src ||
            img.dataset.upgraded === "true" ||
            img.dataset.upgrading === "true"
          ) {
            if (img.dataset.upgraded === "true") {
              img.dataset.loadingState = "loaded";
            }
            return;
          }

          img.dataset.upgrading = "true";

          const highRes = new Image();
          highRes.src = fullSrc;

          // Add timeout for mobile networks (10 seconds)
          const timeoutId = setTimeout(() => {
            if (highRes.complete === false) {
              // Timeout occurred, mark as loaded with current placeholder
              img.dataset.upgraded = "true";
              img.dataset.loadingState = "loaded";
              img.dataset.upgrading = "false";
            }
          }, 10000);

          highRes.onload = () => {
            clearTimeout(timeoutId);
            img.src = fullSrc;
            img.dataset.upgraded = "true";
            img.dataset.loadingState = "loaded";
            img.dataset.upgrading = "false";
          };
          highRes.onerror = () => {
            clearTimeout(timeoutId);
            img.dataset.upgrading = "false";
          };
        };

        if (fullSrc !== placeholder) {
          if (eager) {
            upgradeToHighRes();
          } else {
            scheduleIdle(upgradeToHighRes);
          }
        } else {
          img.dataset.upgraded = "true";
          img.dataset.loadingState = "loaded";
        }
      }

      function createGalleryImage(postData, index) {
        const img = document.createElement("img");
        img.alt = postData.title;
        img.className = "w-full h-auto object-cover aspect-square";
        img.loading = index < EAGER_IMAGE_COUNT ? "eager" : "lazy";
        img.decoding = "async";

        const sources = getPostImageSources(postData);
        img.dataset.placeholder = sources.placeholder;
        img.dataset.fullsrc = sources.full;
        if (index >= EAGER_IMAGE_COUNT) {
          img.dataset.lazy = "true";
        }

        img.classList.add(
          "blur-sm",
          "opacity-60",
          "transition-all",
          "duration-300",
          "ease-out"
        );

        img.onload = function () {
          const loading = img.parentElement?.querySelector(".image-loading");
          if (loading) loading.remove();
          const isHighRes =
            img.dataset.upgraded === "true" ||
            !img.dataset.fullsrc ||
            img.dataset.fullsrc === img.src;
          if (isHighRes) {
            img.classList.remove("blur-sm", "opacity-60");
            img.classList.add("opacity-100");
          }
        };

        img.onerror = function () {
          const wrapper = img.parentElement;
          if (!wrapper) return;
          retryImageLoad(wrapper, postData, index);
        };

        return img;
      }

      function readCachedPopularSubreddits() {
        try {
          const raw = localStorage.getItem(POPULAR_SUBREDDITS_KEY);
          if (!raw) return null;
          const payload = JSON.parse(raw);
          if (!payload?.items?.length) return null;
          if (Date.now() - payload.timestamp > POPULAR_SUBREDDITS_TTL) {
            return null;
          }
          return payload.items;
        } catch (error) {
          console.warn("Failed to read cached popular subreddits:", error);
          return null;
        }
      }

      function storePopularSubreddits(items) {
        try {
          localStorage.setItem(
            POPULAR_SUBREDDITS_KEY,
            JSON.stringify({ items, timestamp: Date.now() })
          );
        } catch (error) {
          console.warn("Unable to persist popular subreddits:", error);
        }
      }

      async function loadPopularSubreddits() {
        const cached = readCachedPopularSubreddits();
        if (cached) {
          return cached;
        }

        try {
          const response = await fetch(
            `https://www.reddit.com/subreddits/popular.json?limit=${
              POPULAR_SUBREDDITS_LIMIT * 3
            }`,
            {
              headers: {
                "User-Agent":
                  "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Reddit-Gallery-Viewer/1.0",
              },
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const json = await response.json();
          const items =
            json?.data?.children
              ?.map((child) => child?.data)
              ?.filter(
                (data) =>
                  data &&
                  !data.over18 &&
                  !data.quarantine &&
                  !data.hide_ads &&
                  !data.restrict_commenting
              )
              ?.slice(0, POPULAR_SUBREDDITS_LIMIT)
              ?.map((data) => ({
                name: data.display_name,
                displayName: `üî• ${data.display_name_prefixed}`,
              })) || [];

          if (items.length) {
            storePopularSubreddits(items);
            return items;
          }
        } catch (error) {
          console.warn("Unable to fetch popular subreddits:", error);
        }

        return null;
      }

      // Apply theme colors to entire page
      function applyTheme(theme) {
        const primary = theme.primary;
        const light = lightenColor(primary, 30);
        const lighter = lightenColor(primary, 60);
        const bgLight = getOptimalBackgroundColor(primary);
        const border = lightenColor(primary, 80);

        // Determine text colors based on brightness
        const primaryTextColor = getTextColorForBackground(primary);
        const lightTextColor = getTextColorForBackground(light);

        // Set CSS variables
        document.documentElement.style.setProperty("--color-primary", primary);
        document.documentElement.style.setProperty(
          "--color-primary-light",
          light
        );
        document.documentElement.style.setProperty(
          "--color-primary-lighter",
          lighter
        );
        document.documentElement.style.setProperty(
          "--color-primary-bg",
          bgLight
        );
        document.documentElement.style.setProperty("--color-accent", lighter);
        document.documentElement.style.setProperty("--color-border", border);

        // Keep body background white (no theme color)
        document.body.style.backgroundColor = "#FFFFFF";

        // Update titles and headers
        const pageTitle = document.getElementById("page-title");
        const pageSubtitle = document.getElementById("page-subtitle");

        if (pageTitle) {
          pageTitle.style.color = primary;
        }
        // Make subtitle darker and more readable
        if (pageSubtitle) {
          pageSubtitle.style.color =
            getColorBrightness(primary) > 0.6
              ? darkenColor(primary, 20)
              : light;
          pageSubtitle.style.fontWeight = "600";
        }

        // Update input border and styling
        const input = document.getElementById("custom-subreddit-input");
        if (input) {
          input.style.borderColor = primary;
          input.style.borderWidth = "2px";
        }

        // Update all buttons with proper colors
        document.querySelectorAll("button").forEach((btn) => {
          // Subreddit selector buttons
          if (
            btn.parentId === "subreddit-selector" ||
            btn.closest("#subreddit-selector")
          ) {
            btn.style.backgroundColor = "white";
            btn.style.color = primary;
            btn.style.borderColor = light;
          }
          // Time filter buttons
          else if (btn.closest("#time-filter-selector")) {
            btn.style.backgroundColor = border;
            btn.style.color = primary;
          }
          // Main action buttons
          else if (
            btn.classList.contains("bg-green-600") ||
            btn.id === "custom-subreddit-btn"
          ) {
            btn.style.backgroundColor = primary;
            btn.style.color = "white";
          }
          // Modal navigation buttons
          else if (btn.id === "modal-prev-btn" || btn.id === "modal-next-btn") {
            btn.style.color = primary;
          }
        });

        // Update links
        document.querySelectorAll("a").forEach((link) => {
          if (link.classList.contains("bg-green-600")) {
            link.style.backgroundColor = primary;
            link.style.color = "white";
          }
        });

        // Update loading indicator directly
        const loadingElement = document.getElementById("loading");
        if (loadingElement) {
          loadingElement.style.color = primary;
          // Update SVG elements
          const svg = loadingElement.querySelector("svg");
          if (svg) {
            svg.style.color = primary;
            svg.style.stroke = primary;
            svg.style.fill = primary;
            svg.querySelectorAll("circle, path").forEach((el) => {
              el.style.stroke = primary;
              el.style.fill = primary;
              el.style.color = primary;
            });
          }
          // Update text
          const p = loadingElement.querySelector("p");
          if (p) {
            p.style.color = primary;
          }
        }

        // Create comprehensive style updates
        const rgb = hexToRgb(primary);
        const style = document.createElement("style");
        style.textContent = `
          body {
            background-color: #FFFFFF !important;
          }
          #page-title {
            color: ${primary} !important;
          }
          #page-subtitle {
            color: ${
              getColorBrightness(primary) > 0.6
                ? darkenColor(primary, 20)
                : light
            } !important;
            font-weight: 600 !important;
          }
          #custom-subreddit-input {
            border-color: ${primary} !important;
          }
          #custom-subreddit-btn {
            background-color: ${primary} !important;
            color: white !important;
          }
          #custom-subreddit-btn:hover {
            background-color: ${light} !important;
          }
          #subreddit-selector button {
            background-color: white !important;
            color: ${primary} !important;
            border: 1px solid ${light} !important;
          }
          #subreddit-selector button:hover {
            background-color: ${bgLight} !important;
          }
          #subreddit-selector button[style*="background-color"] {
            background-color: ${primary} !important;
            color: white !important;
          }
          #time-filter-selector button {
            background-color: ${border} !important;
            color: ${primary} !important;
          }
          #time-filter-selector button:hover {
            background-color: ${light} !important;
            color: white !important;
          }
          #time-filter-selector button[style*="background-color"] {
            background-color: ${primary} !important;
            color: white !important;
          }
          .shadow-md {
            box-shadow: 0 4px 6px -1px rgba(${rgb.r}, ${rgb.g}, ${
          rgb.b
        }, 0.1) !important;
          }
          #error-message {
            background-color: ${lightenColor(primary, 92)} !important;
            border-color: ${primary} !important;
            color: ${primary} !important;
          }
          #error-message strong {
            color: ${primary} !important;
          }
          .image-error {
            border-color: ${border} !important;
          }
          .retry-btn {
            border-color: ${border} !important;
            color: ${primary} !important;
          }
          .retry-btn:hover {
            background-color: ${border} !important;
          }
          #loading {
            color: ${primary} !important;
          }
          #loading p {
            color: ${primary} !important;
          }
          #loading svg {
            color: ${primary} !important;
            stroke: ${primary} !important;
          }
          #loading svg circle,
          #loading svg path {
            stroke: ${primary} !important;
            fill: ${primary} !important;
            color: ${primary} !important;
          }
        `;

        // Remove old style tag if it exists
        const oldStyle = document.getElementById("theme-style");
        if (oldStyle) oldStyle.remove();

        style.id = "theme-style";
        document.head.appendChild(style);
      }

      // Parse subreddit name from URL or direct name
      function parseSubredditName(input) {
        input = input.trim();

        // Handle various Reddit URL formats
        const urlPatterns = [
          /https?:\/\/(?:www\.)?reddit\.com\/r\/([a-zA-Z0-9_-]+)/i, // https://reddit.com/r/houseplants
          /https?:\/\/(?:www\.)?reddit\.com\/r\/([a-zA-Z0-9_-]+)\//i, // https://reddit.com/r/houseplants/
          /^r\/([a-zA-Z0-9_-]+)/i, // r/houseplants
        ];

        for (const pattern of urlPatterns) {
          const match = input.match(pattern);
          if (match) {
            return match[1];
          }
        }

        // If no URL format matched, return input as-is (assume it's a subreddit name)
        if (/^[a-zA-Z0-9_-]+$/.test(input)) {
          return input;
        }

        return null;
      }

      function updateModalContent(index) {
        if (index < 0 || index >= imagePosts.length) return;

        currentImageIndex = index;
        const postData = imagePosts[index];

        // Set image with error handling
        modalImage.src = "";
        modalImage.onload = function () {
          // Image loaded successfully
        };
        modalImage.onerror = function () {
          // Retry with delay
          setTimeout(() => {
            modalImage.src = sanitizeRedditImageUrl(postData.url);
          }, 1000);
        };
        modalImage.src = sanitizeRedditImageUrl(postData.url);
        modalImage.alt = postData.title;
        modalTitle.textContent = postData.title;
        modalLink.href = `https://www.reddit.com${postData.permalink}`;

        // Disable previous/next buttons at boundaries
        modalPrevBtn.disabled = index === 0;
        modalNextBtn.disabled = index === imagePosts.length - 1;
        modalPrevBtn.style.opacity = index === 0 ? "0.5" : "1";
        modalNextBtn.style.opacity =
          index === imagePosts.length - 1 ? "0.5" : "1";
        modalPrevBtn.style.cursor = index === 0 ? "not-allowed" : "pointer";
        modalNextBtn.style.cursor =
          index === imagePosts.length - 1 ? "not-allowed" : "pointer";
      }

      function openModal(imageUrl, postUrl, title, index) {
        currentImageIndex = index;
        updateModalContent(index);
        modal.classList.remove("hidden");
        setTimeout(() => {
          modal.classList.add("opacity-100");
          modal.querySelector(".transform").classList.remove("scale-95");
        }, 10);
        document.body.style.overflow = "hidden";
      }

      function showPreviousImage() {
        if (currentImageIndex > 0) {
          updateModalContent(currentImageIndex - 1);
        }
      }

      function showNextImage() {
        if (currentImageIndex < imagePosts.length - 1) {
          updateModalContent(currentImageIndex + 1);
        }
      }

      function closeModal() {
        modal.classList.remove("opacity-100");
        modal.querySelector(".transform").classList.add("scale-95");
        setTimeout(() => modal.classList.add("hidden"), 300);
        document.body.style.overflow = "";
      }

      modalCloseBtn.addEventListener("click", closeModal);
      modal.addEventListener(
        "click",
        (e) => e.target === modal && closeModal()
      );
      modalPrevBtn.addEventListener("click", showPreviousImage);
      modalNextBtn.addEventListener("click", showNextImage);
      document.addEventListener("keydown", (e) => {
        if (modal.classList.contains("hidden")) return;
        if (e.key === "Escape") {
          closeModal();
        } else if (e.key === "ArrowLeft") {
          showPreviousImage();
        } else if (e.key === "ArrowRight") {
          showNextImage();
        }
      });

      // Share button handler
      shareBtn.addEventListener("click", () => {
        const currentURL = window.location.href;
        navigator.clipboard.writeText(currentURL).then(() => {
          // Show feedback
          shareFeedback.classList.remove("hidden");
          setTimeout(() => {
            shareFeedback.classList.add("hidden");
          }, 2000);
        }).catch(() => {
          // Fallback if clipboard API fails
          alert("Share link: " + currentURL);
        });
      });

      // Initialize lazy loading observer
      function initImageObserver() {
        if (imageObserver) {
          imageObserver.disconnect();
        }
        imageObserver = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                const img = entry.target;
                loadProgressiveImage(img);
                img.dataset.lazy = "false";
                imageObserver.unobserve(img);
              }
            });
          },
          { rootMargin: "50px", threshold: 0.25 }
        );

        // Observe all pending images
        document.querySelectorAll('img[data-lazy="true"]').forEach((img) => {
          imageObserver.observe(img);
        });
      }

      // Retry loading image
      function retryImageLoad(wrapper, postData, postIndex) {
        if (!wrapper) return;

        const retryKey =
          postData.id ||
          postData.name ||
          sanitizeRedditImageUrl(postData.url) ||
          `post-${postIndex}`;

        const retryCount = imageRetryMap.get(retryKey) || 0;
        const maxRetries = 5; // Increased retries for mobile

        if (retryCount >= maxRetries) {
          const retryBtn = document.createElement("div");
          retryBtn.className = "retry-btn p-4 flex flex-col gap-2";
          retryBtn.innerHTML = `<span>‚ü≤ Tap to Retry</span><span style="font-size: 0.7rem;">Failed after ${retryCount} attempts</span>`;
          retryBtn.onclick = () => {
            imageRetryMap.set(retryKey, 0);
            retryImageLoad(wrapper, postData, postIndex);
          };
          wrapper.innerHTML = "";
          wrapper.appendChild(retryBtn);
          return;
        }

        imageRetryMap.set(retryKey, retryCount + 1);
        wrapper.innerHTML = "";
        const loadingDiv = document.createElement("div");
        loadingDiv.className = "image-loading";
        wrapper.appendChild(loadingDiv);

        const img = createGalleryImage(postData, postIndex);
        wrapper.appendChild(img);

        // Add exponential backoff delay for retries
        const delayMs = Math.min(1000 * Math.pow(2, retryCount), 10000); // Max 10 seconds
        setTimeout(() => {
          loadProgressiveImage(img, { eager: true });
        }, delayMs);
      }

      async function fetchImages(subreddit, timeFilter) {
        galleryContainer.innerHTML = "";
        imageRetryMap.clear(); // Clear retry map for new gallery
        loadingIndicator.classList.remove("hidden");
        errorMessage.classList.add("hidden");

        const matchedSubreddit = subreddits.find((s) => s.name === subreddit);
        const displayLabel = matchedSubreddit?.displayName || `/r/${subreddit}`;
        const plainName = matchedSubreddit?.name || subreddit;
        pageTitle.textContent = `Reddit ${plainName} Gallery`;
        pageSubtitle.textContent = `Top images from ${displayLabel} (${timeFilter.displayName})`;

        // ‰øùÂ≠òÂà∞ÊêúÁ¥¢ÂéÜÂè≤
        addToSearchHistory({ name: subreddit, displayName: displayLabel });

        // Fetch and apply subreddit theme
        const theme = await fetchSubredditTheme(subreddit);
        applyTheme(theme);

        try {
          const data = await fetchWithCache(
            buildApiUrl(subreddit, timeFilter.name)
          );
          loadingIndicator.classList.add("hidden");

          const filteredPosts = data.data.children
            .filter(
              (post) =>
                post.data.post_hint === "image" ||
                (post.data.url &&
                  (post.data.url.endsWith(".jpg") ||
                    post.data.url.endsWith(".png") ||
                    post.data.url.endsWith(".gif")))
            )
            .slice(0, MAX_VISIBLE_POSTS)
            .map((post) => post.data);

          imagePosts = filteredPosts;

          if (imagePosts.length === 0) {
            errorMessage.querySelector(
              "span"
            ).textContent = `No image posts found in /r/${subreddit} (${timeFilter.displayName}).`;
            errorMessage.classList.remove("hidden");
            return;
          }

          const fragment = document.createDocumentFragment();

          imagePosts.forEach((postData, index) => {
            const card = document.createElement("div");
            card.className =
              "bg-white rounded-lg shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-300 group cursor-pointer";
            card.addEventListener("click", () =>
              openModal(
                sanitizeRedditImageUrl(postData.url),
                `https://www.reddit.com${postData.permalink}`,
                postData.title,
                index
              )
            );

            const imgWrapper = document.createElement("div");
            imgWrapper.className = "relative";

            // Create loading placeholder
            const loadingDiv = document.createElement("div");
            loadingDiv.className = "image-loading";
            imgWrapper.appendChild(loadingDiv);

            // Create img with lazy loading for everything beyond the eager threshold
            const img = createGalleryImage(postData, index);
            imgWrapper.appendChild(img);

            const overlay = document.createElement("div");
            overlay.className =
              "absolute bottom-0 left-0 right-0 p-4 bg-black bg-opacity-60 text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300";
            overlay.textContent = postData.title;

            card.appendChild(imgWrapper);
            card.appendChild(overlay);
            fragment.appendChild(card);

            if (index < EAGER_IMAGE_COUNT) {
              loadProgressiveImage(img, { eager: true });
            }
          });

          galleryContainer.appendChild(fragment);

          // Initialize lazy loading after rendering
          initImageObserver();
        } catch (error) {
          console.error("Fetch error:", error);
          loadingIndicator.classList.add("hidden");
          errorMessage.classList.remove("hidden");
        }
      }

      function renderSubredditButtons() {
        subredditSelector.innerHTML = "";
        const fragment = document.createDocumentFragment();

        subreddits.forEach((sub) => {
          const button = document.createElement("button");
          button.className =
            "px-3 py-1 text-sm rounded font-medium transition-colors duration-200 bg-white shadow-sm";
          button.style.color = "#FF4500";
          button.textContent = sub.displayName;
          button.dataset.subreddit = sub.name;
          button.addEventListener("click", (e) => {
            const target = e.currentTarget;
            if (!target) return;
            if (currentSubreddit === sub.name) return;
            currentSubreddit = sub.name;
            setActiveButton("#subreddit-selector button", target);
            updateURL(currentSubreddit, currentTimeFilter);
            fetchImages(currentSubreddit, currentTimeFilter);
          });
          fragment.appendChild(button);
        });

        subredditSelector.appendChild(fragment);

        return subredditSelector.querySelector(
          `[data-subreddit="${currentSubreddit}"]`
        );
      }

      function setActiveButton(selector, activeButton) {
        if (!activeButton) return;
        document.querySelectorAll(selector).forEach((btn) => {
          btn.classList.remove("shadow-md");
          btn.style.backgroundColor = "white";
          btn.style.color = "#FF4500";
        });
        activeButton.classList.add("shadow-md");
        activeButton.style.backgroundColor = "#FF4500";
        activeButton.style.color = "white";
      }

      function renderSearchHistory() {
        const history = getSearchHistory();
        const historyContainer = document.getElementById("history-container");
        const historySelector = document.getElementById("history-selector");

        if (history.length === 0) {
          historyContainer.classList.add("hidden");
          return;
        }

        historyContainer.classList.remove("hidden");
        historySelector.innerHTML = "";

        history.forEach((item) => {
          const button = document.createElement("button");
          button.className =
            "px-3 py-1 rounded-md text-sm font-medium transition-colors duration-200 bg-gray-100 text-gray-600 hover:bg-gray-200";
          button.style.color = "#FF4500";
          button.style.borderRadius = "6px";
          button.textContent = `${item.displayName}`;
          button.title = `/r/${item.name}`;
          button.addEventListener("click", () => {
            currentSubreddit = item.name;
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            document
              .querySelectorAll("#subreddit-selector button")
              .forEach((btn) => {
                btn.classList.remove("shadow-md");
                btn.style.backgroundColor = "white";
                btn.style.color = "#FF4500";
              });
            updateURL(currentSubreddit, currentTimeFilter);
            fetchImages(currentSubreddit, currentTimeFilter);
          });
          historySelector.appendChild(button);
        });
      }

      // Handle custom subreddit input
      function handleCustomSubreddit() {
        const input = customSubredditInput.value;

        if (!input) {
          alert("Please enter a subreddit name or link");
          return;
        }

        const subredditName = parseSubredditName(input);

        if (!subredditName) {
          alert(
            "Invalid subreddit name or link format. Please enter a valid name or link."
          );
          customSubredditInput.focus();
          return;
        }

        currentSubreddit = subredditName;
        customSubredditInput.value = ""; // Clear input field

        // Remove active state from all buttons
        document
          .querySelectorAll("#subreddit-selector button")
          .forEach((btn) => {
            btn.classList.remove("shadow-md");
            btn.style.backgroundColor = "white";
            btn.style.color = "#FF4500";
          });

        updateURL(currentSubreddit, currentTimeFilter);
        fetchImages(currentSubreddit, currentTimeFilter);

        // Êõ¥Êñ∞ÊêúÁ¥¢ÂéÜÂè≤ÊòæÁ§∫
        setTimeout(() => renderSearchHistory(), 100);
      }

      // Parse URL query parameters
      function parseURLParameters() {
        const params = new URLSearchParams(window.location.search);
        const urlSubreddit = params.get("sub") || params.get("subreddit");
        const urlTime = params.get("time") || params.get("t");

        return {
          subreddit: urlSubreddit,
          time: urlTime,
        };
      }

      // Update URL without reloading page
      function updateURL(subreddit, timeFilter) {
        const url = new URL(window.location);
        url.searchParams.set("sub", subreddit);
        url.searchParams.set("time", timeFilter.name);
        window.history.replaceState({ subreddit, time: timeFilter.name }, "", url);
      }

      async function initializeApp() {
        const cachedPopular = readCachedPopularSubreddits();
        if (cachedPopular && cachedPopular.length) {
          subreddits = cachedPopular;
          currentSubreddit = subreddits[0].name;
        }

        // Check URL parameters for initial subreddit/time
        const urlParams = parseURLParameters();
        if (urlParams.subreddit) {
          currentSubreddit = urlParams.subreddit;
        }
        if (urlParams.time) {
          const matchedFilter = timeFilters.find((f) => f.name === urlParams.time);
          if (matchedFilter) {
            currentTimeFilter = matchedFilter;
          }
        }

        const initialSubredditButton = renderSubredditButtons();

        // Add custom subreddit input event handling
        customSubredditBtn.addEventListener("click", handleCustomSubreddit);
        customSubredditInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            handleCustomSubreddit();
          }
        });

        // Create time filter buttons with minimal reflow
        const timeFragment = document.createDocumentFragment();
        timeFilters.forEach((filter) => {
          const button = document.createElement("button");
          button.className =
            "px-3 py-1 text-sm rounded font-medium transition-colors duration-200 bg-white shadow-sm";
          button.style.color = "#FF4500";
          button.textContent = filter.displayName;
          button.addEventListener("click", (e) => {
            currentTimeFilter = filter;
            setActiveButton("#time-filter-selector button", e.currentTarget);
            updateURL(currentSubreddit, currentTimeFilter);
            fetchImages(currentSubreddit, currentTimeFilter);
          });
          timeFragment.appendChild(button);
        });
        timeFilterSelector.appendChild(timeFragment);

        // Activate default buttons and load initial data
        setActiveButton(
          "#subreddit-selector button",
          initialSubredditButton || subredditSelector.firstElementChild
        );
        setActiveButton(
          "#time-filter-selector button",
          timeFilterSelector.firstElementChild
        );

        const theme = await fetchSubredditTheme(currentSubreddit);
        applyTheme(theme);

        renderSearchHistory();
        await fetchImages(currentSubreddit, currentTimeFilter);

        // Refresh popular subreddits asynchronously (daily cadence)
        loadPopularSubreddits().then((popular) => {
          if (!popular || !popular.length) return;
          const incomingSignature = popular.map((item) => item.name).join(",");
          const existingSignature = subreddits
            .map((item) => item.name)
            .join(",");
          if (incomingSignature === existingSignature) return;
          const previous = currentSubreddit;
          subreddits = popular;
          currentSubreddit = subreddits[0].name;
          const activeAfterRender = renderSubredditButtons();
          setActiveButton("#subreddit-selector button", activeAfterRender);
          if (previous !== currentSubreddit) {
            fetchImages(currentSubreddit, currentTimeFilter);
          }
        });
      }

      document.addEventListener("DOMContentLoaded", initializeApp);
    </script>
  </body>
</html>
