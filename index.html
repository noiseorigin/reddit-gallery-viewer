<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Free Reddit gallery viewer tool. Browse subreddits as beautiful image galleries with dynamic themes. View top images from any subreddit easily." />
    <meta name="keywords" content="reddit gallery, reddit image viewer, subreddit gallery viewer, reddit tool" />
    <meta name="author" content="Reddit Gallery Viewer" />
    <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />

    <!-- Open Graph for Social Sharing -->
    <meta property="og:title" content="Reddit Gallery Viewer - Browse Subreddits as Image Galleries" />
    <meta property="og:description" content="Free tool to view Reddit subreddits as beautiful image galleries. Browse top images with dynamic color themes." />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://your-domain.vercel.app" />
    <meta name="theme-color" content="#FF4500" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Reddit Gallery Viewer" />
    <meta name="twitter:description" content="Browse Reddit subreddits as beautiful image galleries" />

    <!-- Canonical Tag (Èò≤Ê≠¢ÈáçÂ§çÂÜÖÂÆπÈóÆÈ¢ò) -->
    <link rel="canonical" href="https://your-domain.vercel.app" />

    <!-- Preconnect to external resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="dns-prefetch" href="https://www.reddit.com" />
    <link rel="dns-prefetch" href="https://cdn.tailwindcss.com" />

    <title>Reddit Gallery Viewer - Free Online Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <!-- Google AdSense (commented out - to be enabled later) -->
    <!-- <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX"
     crossorigin="anonymous"></script> -->

    <!-- Google Analytics (commented out - to be enabled later) -->
    <!-- <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-XXXXXXXXXX');
    </script> -->

    <!-- JSON-LD Structured Data for SEO -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Reddit Gallery Viewer",
      "description": "Free tool to browse Reddit subreddits as beautiful image galleries with dynamic themes",
      "url": "https://your-domain.vercel.app",
      "applicationCategory": "UtilityApplication",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "author": {
        "@type": "Organization",
        "name": "Reddit Gallery Viewer",
        "url": "https://your-domain.vercel.app"
      }
    }
    </script>

    <style>
      :root {
        /* Reddit Official Colors */
        --color-primary: #FF4500;        /* Reddit Orange */
        --color-primary-light: #FF6D00;  /* Lighter Orange */
        --color-primary-lighter: #FFB6A3; /* Very Light Orange */
        --color-primary-bg: #FFFFFF;     /* White Background */
        --color-accent: #818384;         /* Reddit Gray Accent */
        --color-border: #CCCCCC;         /* Light Gray Border */
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: #FFFFFF;
        color: #1f2937;
      }

      /* Smooth color transitions for all elements */
      * {
        transition: color 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
      }

      /* Allow SVG transitions for theme changes */
      svg {
        transition: color 0.3s ease !important;
      }

      svg circle,
      svg path {
        transition: stroke 0.3s ease, fill 0.3s ease, color 0.3s ease !important;
      }

      /* Prevent transition on img elements */
      img {
        transition: none !important;
      }

      /* Styles applied when image fails to load */
      .image-error {
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: var(--color-primary-bg);
        border: 1px dashed var(--color-border);
        color: #6b7280;
        font-size: 0.875rem;
        text-align: center;
        height: 100%;
        aspect-ratio: 1 / 1;
      }
      /* Image loading placeholder */
      .image-loading {
        display: flex;
        justify-content: center;
        align-items: center;
        background: linear-gradient(90deg, var(--color-primary-lighter) 25%, var(--color-accent) 50%, var(--color-primary-lighter) 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        height: 100%;
        aspect-ratio: 1 / 1;
      }
      @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
      }
      /* Retry button */
      .retry-btn {
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: var(--color-primary-bg);
        border: 1px dashed var(--color-border);
        color: var(--color-primary);
        font-size: 0.875rem;
        text-align: center;
        height: 100%;
        aspect-ratio: 1 / 1;
        cursor: pointer;
      }
      .retry-btn:hover {
        background-color: var(--color-border);
      }
    </style>
  </head>
  <body class="bg-white text-gray-800">
    <div class="container mx-auto p-4 md:p-8">
      <!-- Title Section with SEO Optimization -->
      <header class="text-center mb-6">
        <h1 id="page-title" class="text-4xl font-bold" style="color: #FF4500;">
          Reddit Gallery Viewer
        </h1>
        <p id="page-subtitle" class="text-lg mt-2" style="color: #FF6D00;">Free Online Tool to Browse Subreddits as Image Galleries</p>
        <p class="text-sm text-gray-600 mt-3">
          View top images from any Reddit subreddit with beautiful galleries and dynamic color themes.
        </p>
      </header>

      <!-- Custom Subreddit Input -->
      <div class="flex justify-center mb-8">
        <div class="w-full max-w-md">
          <label class="block text-sm text-gray-600 mb-2" style="color: #666;">
            üîç Search for any Subreddit
          </label>
          <div class="flex gap-2">
            <input
              id="custom-subreddit-input"
              type="text"
              placeholder="e.g., photography, MostBeautiful..."
              class="flex-1 px-4 py-2 border-2 rounded-lg focus:outline-none text-gray-800"
              style="border-color: #CCCCCC; color: #1a1a1b;"
            />
            <button
              id="custom-subreddit-btn"
              class="px-6 text-white font-semibold rounded-lg transition-colors"
              style="background-color: #FF4500;"
              title="Press Enter to search"
            >
              Go
            </button>
          </div>
          <p class="text-xs text-gray-500 mt-2" style="color: #999;">
            üí° Tip: Search by name, URL, or r/name format
          </p>
        </div>
      </div>

      <!-- Subreddit Selector - Popular Subreddits -->
      <div class="mb-6">
        <p class="text-center text-sm text-gray-500 mb-2" style="color: #888;">Popular Subreddits</p>
        <div
          id="subreddit-selector"
          class="flex flex-wrap justify-center items-center gap-2 md:gap-3 mb-4"
        >
          <!-- Subreddit buttons will be dynamically inserted here -->
        </div>
      </div>

      <!-- Search History - Recently Viewed -->
      <div id="history-container" class="mb-6 hidden">
        <p class="text-center text-sm text-gray-500 mb-2" style="color: #888;">Recently Viewed</p>
        <div
          id="history-selector"
          class="flex flex-wrap justify-center items-center gap-2 md:gap-3 mb-4"
        >
          <!-- Search history buttons will be dynamically inserted here -->
        </div>
      </div>

      <!-- Time Filter -->
      <div class="mb-8">
        <p class="text-center text-sm text-gray-500 mb-3" style="color: #888;">üìÖ Time Period</p>
        <div
          id="time-filter-selector"
          class="flex flex-wrap justify-center items-center gap-2 md:gap-3"
        >
          <!-- Time filter buttons will be dynamically inserted here -->
        </div>
      </div>

      <!-- Loading Indicator -->
      <div id="loading" class="text-center py-12">
        <div class="flex justify-center items-center">
          <svg
            class="animate-spin -ml-1 mr-3 h-8 w-8"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            style="color: #FF4500;"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
          <p class="text-xl" style="color: #FF4500;">Loading images from Reddit...</p>
        </div>
      </div>

      <!-- Error Message -->
      <div
        id="error-message"
        class="hidden text-center bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative"
        role="alert"
      >
        <strong class="font-bold">Failed to Load!</strong>
        <span class="block sm:inline"
          >Unable to fetch data from Reddit. Please try again later.</span
        >
      </div>

      <!-- Image Gallery -->
      <div
        id="gallery"
        class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6"
      >
        <!-- Image cards will be dynamically inserted here -->
      </div>

      <!-- AdSense Advertisement (commented out - to be enabled later) -->
      <!-- <div class="mt-12 text-center">
        <div style="background-color: #f9fafb; padding: 20px; border-radius: 8px; margin: 20px 0;">
          <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
          <ins class="adsbygoogle"
               style="display:block; text-align:center;"
               data-ad-layout="in-article"
               data-ad-format="fluid"
               data-ad-client="ca-pub-XXXXXXXXXXXXXXXX"
               data-ad-slot="XXXXXXXXXX"></ins>
          <script>
               (adsbygoogle = window.adsbygoogle || []).push({});
          </script>
        </div>
      </div> -->
    </div>

    <!-- Image Preview Modal -->
    <div
      id="image-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4 transition-opacity duration-300"
    >
      <div
        class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-full overflow-y-auto transform transition-transform duration-300 scale-95"
      >
        <div class="p-4 sm:p-6 relative">
          <button
            id="modal-close-btn"
            class="absolute top-3 right-3 text-gray-400 hover:text-gray-800 text-4xl leading-none font-bold"
          >
            &times;
          </button>
          <h3
            id="modal-title"
            class="text-xl font-semibold text-gray-800 mb-4 pr-8"
          ></h3>
          <div class="flex items-center justify-center gap-4">
            <button
              id="modal-prev-btn"
              class="text-gray-600 hover:text-gray-800 text-3xl leading-none font-bold p-2 hover:bg-gray-100 rounded transition-colors"
              title="Previous image (Left arrow)"
            >
              &#10094;
            </button>
            <div class="flex justify-center bg-gray-100 rounded flex-1">
              <img
                id="modal-image"
                src=""
                alt="Image Preview"
                class="max-h-[70vh] w-auto mx-auto rounded"
              />
            </div>
            <button
              id="modal-next-btn"
              class="text-gray-600 hover:text-gray-800 text-3xl leading-none font-bold p-2 hover:bg-gray-100 rounded transition-colors"
              title="Next image (Right arrow)"
            >
              &#10095;
            </button>
          </div>
          <div class="mt-5 text-center">
            <a
              id="modal-link"
              href="#"
              target="_blank"
              rel="noopener noreferrer"
              class="inline-block text-white font-bold py-2 px-6 rounded-lg transition-colors shadow hover:shadow-lg"
              style="background-color: #FF4500;"
            >
              View on Reddit
            </a>
          </div>
        </div>
      </div>
    </div>

    <script>
      const galleryContainer = document.getElementById("gallery");
      const loadingIndicator = document.getElementById("loading");
      const errorMessage = document.getElementById("error-message");
      const subredditSelector = document.getElementById("subreddit-selector");
      const timeFilterSelector = document.getElementById(
        "time-filter-selector"
      );
      const pageTitle = document.getElementById("page-title");
      const pageSubtitle = document.getElementById("page-subtitle");
      const customSubredditInput = document.getElementById("custom-subreddit-input");
      const customSubredditBtn = document.getElementById("custom-subreddit-btn");

      const modal = document.getElementById("image-modal");
      const modalImage = document.getElementById("modal-image");
      const modalTitle = document.getElementById("modal-title");
      const modalLink = document.getElementById("modal-link");
      const modalCloseBtn = document.getElementById("modal-close-btn");
      const modalPrevBtn = document.getElementById("modal-prev-btn");
      const modalNextBtn = document.getElementById("modal-next-btn");

      let currentImageIndex = 0;
      let imagePosts = [];
      let imageObserver = null;
      const imageRetryMap = new Map(); // Track retry attempts for each image

      const subreddits = [
        { name: "photography", displayName: "üì∏ Photography" },
        { name: "EarthPorn", displayName: "üåç Nature" },
        { name: "CatsStandingUp", displayName: "üê± Cats" },
        { name: "InteriorDesign", displayName: "üè† Interior Design" },
        { name: "Art", displayName: "üé® Art" },
        { name: "FoodPorn", displayName: "üçï Food" },
        { name: "houseplants", displayName: "üå± Houseplants" },
      ];

      const timeFilters = [
        { name: "day", displayName: "üìÜ Today" },
        { name: "week", displayName: "üìÖ This Week" },
        { name: "month", displayName: "üìä This Month" },
      ];

      let currentSubreddit = subreddits[0].name;
      let currentTimeFilter = timeFilters[0];

      // API ÁºìÂ≠òÊú∫Âà∂
      const apiCache = new Map();
      const CACHE_DURATION = 1000 * 60 * 5; // 5 ÂàÜÈíüÁºìÂ≠ò

      // ÊêúÁ¥¢ÂéÜÂè≤ÁºìÂ≠ò
      const SEARCH_HISTORY_KEY = "reddit_gallery_history";
      const MAX_HISTORY = 10;

      function getSearchHistory() {
        try {
          const history = localStorage.getItem(SEARCH_HISTORY_KEY);
          return history ? JSON.parse(history) : [];
        } catch (e) {
          return [];
        }
      }

      function addToSearchHistory(subreddit) {
        try {
          let history = getSearchHistory();
          // ÁßªÈô§ÈáçÂ§çÈ°π
          history = history.filter(item => item.name !== subreddit.name);
          // Ê∑ªÂä†Âà∞ÂºÄÂ§¥
          history.unshift(subreddit);
          // ÈôêÂà∂ÂéÜÂè≤ËÆ∞ÂΩïÊï∞Èáè
          history = history.slice(0, MAX_HISTORY);
          // ‰øùÂ≠òÂà∞ localStorage
          localStorage.setItem(SEARCH_HISTORY_KEY, JSON.stringify(history));
        } catch (e) {
          console.warn("Êó†Ê≥ï‰øùÂ≠òÊêúÁ¥¢ÂéÜÂè≤:", e);
        }
      }

      const buildApiUrl = (subreddit, time) =>
        `https://www.reddit.com/r/${subreddit}/top/.json?t=${time}&limit=100`;

      const buildSubredditInfoUrl = (subreddit) =>
        `https://www.reddit.com/r/${subreddit}/about.json`;

      // Ê∑ªÂä† User-Agent ÂíåÁºìÂ≠òÊîØÊåÅÁöÑ fetch
      async function fetchWithCache(url) {
        const cacheKey = url;
        const now = Date.now();

        // Ê£ÄÊü•ÁºìÂ≠ò
        if (apiCache.has(cacheKey)) {
          const cached = apiCache.get(cacheKey);
          if (now - cached.time < CACHE_DURATION) {
            console.log('Using cached data for:', url);
            return cached.data;
          }
        }

        try {
          const response = await fetch(url, {
            headers: {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) Reddit-Gallery-Viewer/1.0'
            }
          });

          if (!response.ok) throw new Error(`HTTP ${response.status}`);

          const data = await response.json();
          apiCache.set(cacheKey, { data, time: now });
          return data;
        } catch (error) {
          console.error('Fetch error:', error);
          throw error;
        }
      }

      // Default theme colors (Reddit Official Colors)
      const defaultTheme = {
        primary: "#FF4500",    // Reddit Orange
        secondary: "#FFB6A3",  // Light Orange
        background: "#FFF7F0", // Very Light Orange
      };

      // Validate hex color
      function isValidHexColor(color) {
        return /^#[0-9A-F]{6}$/i.test(color);
      }

      // Convert hex to RGB
      function hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result
          ? {
              r: parseInt(result[1], 16),
              g: parseInt(result[2], 16),
              b: parseInt(result[3], 16),
            }
          : null;
      }

      // Convert RGB to hex
      function rgbToHex(r, g, b) {
        return "#" + [r, g, b].map((x) => {
          const hex = x.toString(16);
          return hex.length === 1 ? "0" + hex : hex;
        }).join("");
      }

      // Lighten color by percentage
      function lightenColor(hex, percent) {
        const rgb = hexToRgb(hex);
        if (!rgb) return hex;
        const factor = 1 + percent / 100;
        return rgbToHex(
          Math.min(255, Math.round(rgb.r * factor)),
          Math.min(255, Math.round(rgb.g * factor)),
          Math.min(255, Math.round(rgb.b * factor))
        );
      }

      // Darken color by percentage
      function darkenColor(hex, percent) {
        const rgb = hexToRgb(hex);
        if (!rgb) return hex;
        const factor = 1 - percent / 100;
        return rgbToHex(
          Math.max(0, Math.round(rgb.r * factor)),
          Math.max(0, Math.round(rgb.g * factor)),
          Math.max(0, Math.round(rgb.b * factor))
        );
      }

      // Calculate color brightness (0-1, where 1 is brightest)
      function getColorBrightness(hex) {
        const rgb = hexToRgb(hex);
        if (!rgb) return 0.5;
        // Using luminance formula from WCAG
        const luminance =
          (0.299 * rgb.r + 0.587 * rgb.g + 0.114 * rgb.b) / 255;
        return luminance;
      }

      // Determine if text should be light or dark based on background brightness
      function getTextColorForBackground(bgHex) {
        const brightness = getColorBrightness(bgHex);
        return brightness > 0.5 ? "#000000" : "#FFFFFF";
      }

      // Calculate optimal background brightness
      function getOptimalBackgroundColor(primaryHex) {
        const brightness = getColorBrightness(primaryHex);
        // If primary color is already light, use less light background
        // If primary color is dark, use more light background
        if (brightness < 0.3) {
          return lightenColor(primaryHex, 95); // Very light for dark colors
        } else if (brightness < 0.6) {
          return lightenColor(primaryHex, 90); // Light for medium colors
        } else {
          return lightenColor(primaryHex, 85); // Slightly less light for bright colors
        }
      }

      // Use default Reddit colors (not fetching from subreddit)
      async function fetchSubredditTheme(subreddit) {
        // Always use default Reddit colors, don't customize per subreddit
        return {
          primary: defaultTheme.primary,      // #FF4500 (Reddit Orange)
          accent: defaultTheme.secondary,     // #FFB6A3 (Light Orange)
        };
      }

      // Apply theme colors to entire page
      function applyTheme(theme) {
        const primary = theme.primary;
        const light = lightenColor(primary, 30);
        const lighter = lightenColor(primary, 60);
        const bgLight = getOptimalBackgroundColor(primary);
        const border = lightenColor(primary, 80);

        // Determine text colors based on brightness
        const primaryTextColor = getTextColorForBackground(primary);
        const lightTextColor = getTextColorForBackground(light);

        // Set CSS variables
        document.documentElement.style.setProperty("--color-primary", primary);
        document.documentElement.style.setProperty("--color-primary-light", light);
        document.documentElement.style.setProperty("--color-primary-lighter", lighter);
        document.documentElement.style.setProperty("--color-primary-bg", bgLight);
        document.documentElement.style.setProperty("--color-accent", lighter);
        document.documentElement.style.setProperty("--color-border", border);

        // Keep body background white (no theme color)
        document.body.style.backgroundColor = "#FFFFFF";

        // Update titles and headers
        const pageTitle = document.getElementById("page-title");
        const pageSubtitle = document.getElementById("page-subtitle");

        if (pageTitle) {
          pageTitle.style.color = primary;
        }
        // Make subtitle darker and more readable
        if (pageSubtitle) {
          pageSubtitle.style.color = getColorBrightness(primary) > 0.6 ? darkenColor(primary, 20) : light;
          pageSubtitle.style.fontWeight = "600";
        }

        // Update input border and styling
        const input = document.getElementById("custom-subreddit-input");
        if (input) {
          input.style.borderColor = primary;
          input.style.borderWidth = "2px";
        }

        // Update all buttons with proper colors
        document.querySelectorAll("button").forEach((btn) => {
          // Subreddit selector buttons
          if (btn.parentId === "subreddit-selector" || btn.closest("#subreddit-selector")) {
            btn.style.backgroundColor = "white";
            btn.style.color = primary;
            btn.style.borderColor = light;
          }
          // Time filter buttons
          else if (btn.closest("#time-filter-selector")) {
            btn.style.backgroundColor = border;
            btn.style.color = primary;
          }
          // Main action buttons
          else if (
            btn.classList.contains("bg-green-600") ||
            btn.id === "custom-subreddit-btn"
          ) {
            btn.style.backgroundColor = primary;
            btn.style.color = "white";
          }
          // Modal navigation buttons
          else if (
            btn.id === "modal-prev-btn" ||
            btn.id === "modal-next-btn"
          ) {
            btn.style.color = primary;
          }
        });

        // Update links
        document.querySelectorAll("a").forEach((link) => {
          if (link.classList.contains("bg-green-600")) {
            link.style.backgroundColor = primary;
            link.style.color = "white";
          }
        });

        // Update loading indicator directly
        const loadingElement = document.getElementById("loading");
        if (loadingElement) {
          loadingElement.style.color = primary;
          // Update SVG elements
          const svg = loadingElement.querySelector("svg");
          if (svg) {
            svg.style.color = primary;
            svg.style.stroke = primary;
            svg.style.fill = primary;
            svg.querySelectorAll("circle, path").forEach((el) => {
              el.style.stroke = primary;
              el.style.fill = primary;
              el.style.color = primary;
            });
          }
          // Update text
          const p = loadingElement.querySelector("p");
          if (p) {
            p.style.color = primary;
          }
        }

        // Create comprehensive style updates
        const rgb = hexToRgb(primary);
        const style = document.createElement("style");
        style.textContent = `
          body {
            background-color: #FFFFFF !important;
          }
          #page-title {
            color: ${primary} !important;
          }
          #page-subtitle {
            color: ${getColorBrightness(primary) > 0.6 ? darkenColor(primary, 20) : light} !important;
            font-weight: 600 !important;
          }
          #custom-subreddit-input {
            border-color: ${primary} !important;
          }
          #custom-subreddit-btn {
            background-color: ${primary} !important;
            color: white !important;
          }
          #custom-subreddit-btn:hover {
            background-color: ${light} !important;
          }
          #subreddit-selector button {
            background-color: white !important;
            color: ${primary} !important;
            border: 1px solid ${light} !important;
          }
          #subreddit-selector button:hover {
            background-color: ${bgLight} !important;
          }
          #subreddit-selector button[style*="background-color"] {
            background-color: ${primary} !important;
            color: white !important;
          }
          #time-filter-selector button {
            background-color: ${border} !important;
            color: ${primary} !important;
          }
          #time-filter-selector button:hover {
            background-color: ${light} !important;
            color: white !important;
          }
          #time-filter-selector button[style*="background-color"] {
            background-color: ${primary} !important;
            color: white !important;
          }
          .shadow-md {
            box-shadow: 0 4px 6px -1px rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.1) !important;
          }
          #error-message {
            background-color: ${lightenColor(primary, 92)} !important;
            border-color: ${primary} !important;
            color: ${primary} !important;
          }
          #error-message strong {
            color: ${primary} !important;
          }
          .image-error {
            border-color: ${border} !important;
          }
          .retry-btn {
            border-color: ${border} !important;
            color: ${primary} !important;
          }
          .retry-btn:hover {
            background-color: ${border} !important;
          }
          #loading {
            color: ${primary} !important;
          }
          #loading p {
            color: ${primary} !important;
          }
          #loading svg {
            color: ${primary} !important;
            stroke: ${primary} !important;
          }
          #loading svg circle,
          #loading svg path {
            stroke: ${primary} !important;
            fill: ${primary} !important;
            color: ${primary} !important;
          }
        `;

        // Remove old style tag if it exists
        const oldStyle = document.getElementById("theme-style");
        if (oldStyle) oldStyle.remove();

        style.id = "theme-style";
        document.head.appendChild(style);
      }

      // Parse subreddit name from URL or direct name
      function parseSubredditName(input) {
        input = input.trim();

        // Handle various Reddit URL formats
        const urlPatterns = [
          /https?:\/\/(?:www\.)?reddit\.com\/r\/([a-zA-Z0-9_-]+)/i,  // https://reddit.com/r/houseplants
          /https?:\/\/(?:www\.)?reddit\.com\/r\/([a-zA-Z0-9_-]+)\//i, // https://reddit.com/r/houseplants/
          /^r\/([a-zA-Z0-9_-]+)/i,                                     // r/houseplants
        ];

        for (const pattern of urlPatterns) {
          const match = input.match(pattern);
          if (match) {
            return match[1];
          }
        }

        // If no URL format matched, return input as-is (assume it's a subreddit name)
        if (/^[a-zA-Z0-9_-]+$/.test(input)) {
          return input;
        }

        return null;
      }

      function updateModalContent(index) {
        if (index < 0 || index >= imagePosts.length) return;

        currentImageIndex = index;
        const postData = imagePosts[index].data;

        // Set image with error handling
        modalImage.src = "";
        modalImage.onload = function () {
          // Image loaded successfully
        };
        modalImage.onerror = function () {
          // Retry with delay
          setTimeout(() => {
            modalImage.src = postData.url;
          }, 1000);
        };
        modalImage.src = postData.url;
        modalImage.alt = postData.title;
        modalTitle.textContent = postData.title;
        modalLink.href = `https://www.reddit.com${postData.permalink}`;

        // Disable previous/next buttons at boundaries
        modalPrevBtn.disabled = index === 0;
        modalNextBtn.disabled = index === imagePosts.length - 1;
        modalPrevBtn.style.opacity = index === 0 ? "0.5" : "1";
        modalNextBtn.style.opacity = index === imagePosts.length - 1 ? "0.5" : "1";
        modalPrevBtn.style.cursor = index === 0 ? "not-allowed" : "pointer";
        modalNextBtn.style.cursor = index === imagePosts.length - 1 ? "not-allowed" : "pointer";
      }

      function openModal(imageUrl, postUrl, title, index) {
        currentImageIndex = index;
        updateModalContent(index);
        modal.classList.remove("hidden");
        setTimeout(() => {
          modal.classList.add("opacity-100");
          modal.querySelector(".transform").classList.remove("scale-95");
        }, 10);
        document.body.style.overflow = "hidden";
      }

      function showPreviousImage() {
        if (currentImageIndex > 0) {
          updateModalContent(currentImageIndex - 1);
        }
      }

      function showNextImage() {
        if (currentImageIndex < imagePosts.length - 1) {
          updateModalContent(currentImageIndex + 1);
        }
      }

      function closeModal() {
        modal.classList.remove("opacity-100");
        modal.querySelector(".transform").classList.add("scale-95");
        setTimeout(() => modal.classList.add("hidden"), 300);
        document.body.style.overflow = "";
      }

      modalCloseBtn.addEventListener("click", closeModal);
      modal.addEventListener(
        "click",
        (e) => e.target === modal && closeModal()
      );
      modalPrevBtn.addEventListener("click", showPreviousImage);
      modalNextBtn.addEventListener("click", showNextImage);
      document.addEventListener(
        "keydown",
        (e) => {
          if (modal.classList.contains("hidden")) return;
          if (e.key === "Escape") {
            closeModal();
          } else if (e.key === "ArrowLeft") {
            showPreviousImage();
          } else if (e.key === "ArrowRight") {
            showNextImage();
          }
        }
      );

      // Initialize lazy loading observer
      function initImageObserver() {
        if (imageObserver) {
          imageObserver.disconnect();
        }
        imageObserver = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                const img = entry.target;
                const src = img.dataset.src;
                if (src && img.src !== src) {
                  img.src = src;
                }
              }
            });
          },
          { rootMargin: "100px" }
        );

        // Observe all pending images
        document.querySelectorAll("img[data-src]").forEach((img) => {
          imageObserver.observe(img);
        });
      }

      // Retry loading image
      function retryImageLoad(wrapper, src, altText, postIndex) {
        const retryCount = imageRetryMap.get(src) || 0;
        if (retryCount >= 3) {
          wrapper.innerHTML = `<div class="image-error p-4">Image failed to load<br/>(${altText})</div>`;
          return;
        }

        imageRetryMap.set(src, retryCount + 1);
        wrapper.innerHTML = `<div class="image-loading"></div>`;

        const img = document.createElement("img");
        img.src = src;
        img.alt = altText;
        img.className = "w-full h-auto object-cover aspect-square";

        img.onload = function () {
          wrapper.innerHTML = "";
          wrapper.appendChild(img);
        };

        img.onerror = function () {
          const retryBtn = document.createElement("div");
          retryBtn.className = "retry-btn p-4 flex flex-col gap-2";
          retryBtn.innerHTML = `<span>‚ü≤ Retry</span><span style="font-size: 0.7rem;">Attempt ${retryCount + 1}/3</span>`;
          retryBtn.onclick = () => retryImageLoad(wrapper, src, altText, postIndex);
          wrapper.innerHTML = "";
          wrapper.appendChild(retryBtn);
        };

        wrapper.innerHTML = "";
        wrapper.appendChild(img);
      }

      async function fetchImages(subreddit, timeFilter) {
        galleryContainer.innerHTML = "";
        imageRetryMap.clear(); // Clear retry map for new gallery
        loadingIndicator.classList.remove("hidden");
        errorMessage.classList.add("hidden");

        const displayName = subreddits.find((s) => s.name === subreddit)?.displayName || subreddit;
        pageTitle.textContent = `Reddit ${displayName} Gallery`;
        pageSubtitle.textContent = `Top images from /r/${subreddit} (${timeFilter.displayName})`;

        // ‰øùÂ≠òÂà∞ÊêúÁ¥¢ÂéÜÂè≤
        addToSearchHistory({ name: subreddit, displayName: displayName });

        // Fetch and apply subreddit theme
        const theme = await fetchSubredditTheme(subreddit);
        applyTheme(theme);

        try {
          const data = await fetchWithCache(buildApiUrl(subreddit, timeFilter.name));
          loadingIndicator.classList.add("hidden");

          imagePosts = data.data.children.filter(
            (post) =>
              post.data.post_hint === "image" ||
              (post.data.url &&
                (post.data.url.endsWith(".jpg") ||
                  post.data.url.endsWith(".png") ||
                  post.data.url.endsWith(".gif")))
          );

          if (imagePosts.length === 0) {
            errorMessage.querySelector(
              "span"
            ).textContent = `No image posts found in /r/${subreddit} (${timeFilter.displayName}).`;
            errorMessage.classList.remove("hidden");
            return;
          }

          imagePosts.forEach((post, index) => {
            const postData = post.data;
            const card = document.createElement("div");
            card.className =
              "bg-white rounded-lg shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-300 group cursor-pointer";
            card.addEventListener("click", () =>
              openModal(
                postData.url,
                `https://www.reddit.com${postData.permalink}`,
                postData.title,
                index
              )
            );

            const imgWrapper = document.createElement("div");
            imgWrapper.className = "relative";

            // Create loading placeholder
            const loadingDiv = document.createElement("div");
            loadingDiv.className = "image-loading";
            imgWrapper.appendChild(loadingDiv);

            // Create img with lazy loading for images beyond first 12
            const img = document.createElement("img");
            img.alt = postData.title;
            img.className = "w-full h-auto object-cover aspect-square";

            img.onload = function () {
              const loading = imgWrapper.querySelector(".image-loading");
              if (loading) loading.remove();
            };

            img.onerror = function () {
              retryImageLoad(imgWrapper, postData.url, postData.title, index);
            };

            // Load first 12 images immediately, rest use lazy loading
            if (index < 12) {
              img.src = postData.url;
            } else {
              img.dataset.src = postData.url;
            }

            imgWrapper.appendChild(img);

            const overlay = document.createElement("div");
            overlay.className =
              "absolute bottom-0 left-0 right-0 p-4 bg-black bg-opacity-60 text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300";
            overlay.textContent = postData.title;

            card.appendChild(imgWrapper);
            card.appendChild(overlay);
            galleryContainer.appendChild(card);
          });

          // Initialize lazy loading after rendering
          initImageObserver();
        } catch (error) {
          console.error("Fetch error:", error);
          loadingIndicator.classList.add("hidden");
          errorMessage.classList.remove("hidden");
        }
      }

      function setActiveButton(selector, activeButton) {
        if (!activeButton) return;
        document.querySelectorAll(selector).forEach((btn) => {
          btn.classList.remove("shadow-md");
          btn.style.backgroundColor = "white";
          btn.style.color = "#FF4500";
        });
        activeButton.classList.add("shadow-md");
        activeButton.style.backgroundColor = "#FF4500";
        activeButton.style.color = "white";
      }

      function renderSearchHistory() {
        const history = getSearchHistory();
        const historyContainer = document.getElementById("history-container");
        const historySelector = document.getElementById("history-selector");

        if (history.length === 0) {
          historyContainer.classList.add("hidden");
          return;
        }

        historyContainer.classList.remove("hidden");
        historySelector.innerHTML = "";

        history.forEach((item) => {
          const button = document.createElement("button");
          button.className =
            "px-3 py-1 rounded-md text-sm font-medium transition-colors duration-200 bg-gray-100 text-gray-600 hover:bg-gray-200";
          button.style.color = "#FF4500";
          button.style.borderRadius = "6px";
          button.textContent = `${item.displayName}`;
          button.title = `/r/${item.name}`;
          button.addEventListener("click", () => {
            currentSubreddit = item.name;
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll("#subreddit-selector button").forEach((btn) => {
              btn.classList.remove("shadow-md");
              btn.style.backgroundColor = "white";
              btn.style.color = "#FF4500";
            });
            fetchImages(currentSubreddit, currentTimeFilter);
          });
          historySelector.appendChild(button);
        });
      }

      // Handle custom subreddit input
      function handleCustomSubreddit() {
        const input = customSubredditInput.value;

        if (!input) {
          alert("Please enter a subreddit name or link");
          return;
        }

        const subredditName = parseSubredditName(input);

        if (!subredditName) {
          alert("Invalid subreddit name or link format. Please enter a valid name or link.");
          customSubredditInput.focus();
          return;
        }

        currentSubreddit = subredditName;
        customSubredditInput.value = ""; // Clear input field

        // Remove active state from all buttons
        document.querySelectorAll("#subreddit-selector button").forEach((btn) => {
          btn.classList.remove("shadow-md");
          btn.style.backgroundColor = "white";
          btn.style.color = "#FF4500";
        });

        fetchImages(currentSubreddit, currentTimeFilter);

        // Êõ¥Êñ∞ÊêúÁ¥¢ÂéÜÂè≤ÊòæÁ§∫
        setTimeout(() => renderSearchHistory(), 100);
      }

      function initializeApp() {
        // Create Subreddit buttons
        subreddits.forEach((sub) => {
          const button = document.createElement("button");
          button.className =
            "px-4 py-2 rounded-lg font-semibold transition-colors duration-200 bg-white shadow-sm";
          button.style.color = "#FF4500";
          button.textContent = sub.displayName;
          button.addEventListener("click", (e) => {
            currentSubreddit = sub.name;
            setActiveButton("#subreddit-selector button", e.target);
            fetchImages(currentSubreddit, currentTimeFilter);
          });
          subredditSelector.appendChild(button);
        });

        // Add custom subreddit input event handling
        customSubredditBtn.addEventListener("click", handleCustomSubreddit);
        customSubredditInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            handleCustomSubreddit();
          }
        });

        // Create time filter buttons
        timeFilters.forEach((filter) => {
          const button = document.createElement("button");
          button.className =
            "px-3 py-1 rounded-md text-sm font-medium transition-colors duration-200 bg-gray-200 text-gray-600 hover:bg-gray-300";
          button.style.color = "#FF4500";
          button.textContent = filter.displayName;
          button.addEventListener("click", (e) => {
            currentTimeFilter = filter;
            setActiveButton("#time-filter-selector button", e.target);
            fetchImages(currentSubreddit, currentTimeFilter);
          });
          timeFilterSelector.appendChild(button);
        });

        // Activate default buttons and load initial data
        // FIX: Use .firstElementChild instead of .firstChild to ensure we select an element, not a text node.
        setActiveButton(
          "#subreddit-selector button",
          subredditSelector.firstElementChild
        );
        setActiveButton(
          "#time-filter-selector button",
          timeFilterSelector.firstElementChild
        );

        // Apply initial theme
        fetchSubredditTheme(currentSubreddit).then((theme) => {
          applyTheme(theme);
        });

        // Ê∏≤ÊüìÊêúÁ¥¢ÂéÜÂè≤
        renderSearchHistory();

        fetchImages(currentSubreddit, currentTimeFilter);
      }

      document.addEventListener("DOMContentLoaded", initializeApp);
    </script>
  </body>
</html>
